---
comments: true
published: true
tags:
  - learning
  - writeup
title: Angr_CTF
date: 2020-07-07
---


ÄÃ¢y lÃ  post ghi láº¡i lá»i giáº£i cá»§a nhá»¯ng bÃ i mÃ¬nh giáº£i Ä‘Æ°á»£c trong Angr_CTF: https://github.com/jakespringer/angr_ctf. Ok, báº¯t Ä‘áº§u luÃ´n nÃ o.

*Note:* BÃ i nÃ y á»Ÿ wordpress thÃ¬ mÃ¬nh ghi khÃ¡ chi tiáº¿t, tuy nhiÃªn khi dá»i qua Ä‘Ã¢y thÃ¬ bá»‡nh lÆ°á»i láº¡i tÃ¡i phÃ¡t. Do Ä‘Ã³ mÃ¬nh sáº½ khÃ´ng ghi láº¡i Ä‘áº§y Ä‘á»§ mÃ  chá»‰ viáº¿t nhá»¯ng 
Ä‘iá»ƒm chÃ­nh thÃ´i (thÃªm ná»¯a lÃ  khÃ´ng cÃ³ hÃ¬nh chá»¥p IDA luÃ´n nha). Äá»ƒ Ä‘á»c bÃ i viáº¿t chi tiáº¿t thÃ¬ báº¡n cÃ³ thá»ƒ vÃ o [Ä‘Ã¢y](https://blackfrost984.wordpress.com/2020/03/30/angr_ctf/)

### 01_angr_avoid

BÃ i nÃ y mÃ¬nh sáº½ dÃ¹ng .explore cá»§a Angr Ä‘á»ƒ giáº£i.
Khi dÃ¹ng .explore() vá»›i tham sá»‘ find, Angr sáº½ tá»± Ä‘á»™ng execute binary Ä‘áº¿n khi Ä‘áº¡t Ä‘Æ°á»£c má»™t state thá»a mÃ£n Ä‘iá»u kiá»‡n cá»§a find. GiÃ¡ trá»‹ cá»§a find cÃ³ thá»ƒ lÃ :
â€“ Má»™t Ä‘á»‹a chá»‰ hoáº·c má»™t list cÃ¡c Ä‘á»‹a chá»‰.
â€“ Má»™t hÃ m. HÃ m nÃ y nháº­n tham sá»‘ lÃ  má»™t state vÃ  tráº£ vá» Ä‘iá»u kiá»‡n mÃ  state Ä‘Ã³ cáº§n thá»a mÃ£n (cÃ¡i nÃ y sáº½ Ä‘Æ°á»£c minh há»a á»Ÿ bÃ i tiáº¿p theo)
CÃ¡c state thá»a mÃ£n sáº½ Ä‘Æ°á»£c Ä‘Æ°a vÃ o 1 stash tÃªn lÃ  found (cÃ³ thá»ƒ hiá»ƒu stash lÃ  1 list cÃ¡c state). Theo máº·c Ä‘á»‹nh, khi tÃ¬m Ä‘Æ°á»£c 1 state thá»a mÃ£n, Angr sáº½ dá»«ng viá»‡c tÃ¬m kiáº¿m, tuy nhiÃªn ta cÃ³ thá»ƒ thay Ä‘á»•i Ä‘iá»u nÃ y báº±ng cÃ¡ch truyá»n thÃªm tham sá»‘ num_found cho .explore().

TÆ°Æ¡ng tá»± vá»›i find ta cÅ©ng cÃ³ tham sá»‘ avoid Ä‘á»ƒ chá»‰ ra nhá»¯ng chá»— mÃ  Angr cáº§n â€œtrÃ¡nhâ€. CÃ¡c giÃ¡ trá»‹ mÃ  avoid cÃ³ thá»ƒ nháº­n cÅ©ng tÆ°Æ¡ng tá»± nhÆ° find. Khi gáº·p pháº£i Ä‘iá»u kiá»‡n khá»›p vá»›i tham sá»‘ avoid, Angr sáº½ bá» state Ä‘ang thá»±c thi vÃ o stash avoided, Ä‘á»“ng thá»i dá»«ng thá»±c thi state Ä‘Ã³.

```python
import angr
proj=angr.Project("./01_angr_avoid")
main=0x08048602
state=proj.factory.entry_state(addr=main)
simgr=proj.factory.simulation_manager(state)
```
â€œGood jobâ€ chá»‰ Ä‘Æ°á»£c in á»Ÿ hÃ m â€œmaybe_goodâ€, nÃªn find sáº½ mang Ä‘á»‹a chá»‰ cá»§a hÃ m nÃ y. BÃªn cáº¡nh Ä‘Ã³ ta cÅ©ng cÃ³ hÃ m â€œavoid_meâ€, hÃ m nÃ y Ä‘Æ°a biáº¿n â€œshould_successâ€ vá» 0 (biáº¿n nÃ y vá» 0 thÃ¬ luÃ´n â€œtry againâ€) nÃªn ta sáº½ trÃ¡nh Ä‘á»‹a chá»‰ hÃ m nÃ y.

```python
import angr
 
proj=angr.Project("./01_angr_avoid")
main=0x08048602
state=proj.factory.entry_state(addr=main)
simgr=proj.factory.simulation_manager(state)
 
good=0x080485E0
bad=0x080485A8
 
simgr.explore(find=good,advoid=bad)
 
if (not simgr.found):
    print("Something is wrong!")
else:
    found=simgr.found[0]
    flag=found.posix.dumps(0)
    print(flag)
```

**Note:** simgr.found lÃ  má»™t list gá»“m nhiá»u state, láº¥y má»™t state trong Ä‘Ã³ giá»‘ng nhÆ° má»™t list bÃ¬nh thÆ°á»ng (simgr.found[0])

### 02_angr_find_condition

Má»›i Ä‘áº§u thÃ¬ mÃ¬nh tÆ°á»Ÿng nÃ³ cÅ©ng giá»‘ng chall trÆ°á»›c, cÆ¡ mÃ  nhÃ¬n vÃ o má»›i tháº¥y ráº¯ng cÃ³ má»™t Ä‘á»‘ng Ä‘á»‹a chá»‰ in chá»¯ â€œGood job.â€ ğŸ™‚ , do Ä‘Ã³ khÃ´ng truyá»n Ä‘á»‹a chá»‰ vÃ´ biáº¿n find Ä‘Æ°á»£c rá»“i.

Váº­y pháº£i truyá»n hÃ m vÃ o thÃ´i, hÃ m nÃ y sáº½ kiá»ƒm tra xem â€œGood job.â€ cÃ³ in ra mÃ n hÃ¬nh khÃ´ng. Ta Ä‘Æ°a thÃªm hÃ m kiá»ƒm tra â€œTry againâ€ vÃ o avoid luÃ´n.

```python
import angr
 
proj=angr.Project("./02_angr_find_condition")
state=proj.factory.entry_state()
simgr=proj.factory.simulation_manager(state)
 
def good(state):
    return "Good Job." in (state.posix.dumps(1)).decode("utf-8")
def bad(state):
    return "Try again." in (state.posix.dumps(1)).decode("utf-8")
 
simgr.explore(find=good,avoid=bad)
import angr
 
proj=angr.Project("./02_angr_find_condition")
state=proj.factory.entry_state()
simgr=proj.factory.simulation_manager(state)
 
def good(state):
    return "Good Job." in (state.posix.dumps(1)).decode("utf-8")
def bad(state):
    return "Try again." in (state.posix.dumps(1)).decode("utf-8")
 
simgr.explore(find=good,avoid=bad)
 
if (simgr.found):
    result=simgr.found[0]
    flag=result.posix.dumps(0).decode("utf-8")
    print (flag)
else:
    print ("Something is wrong")
```

### 03_angr_symbolic_registers

á» chall nÃ y, Angr khÃ´ng tá»± Ä‘á»™ng inject symbol cho mÃ¬nh ná»¯a. LÃ½ do lÃ  bá»Ÿi Angr chá»‰ cÃ³ thá»ƒ xá»­ lÃ½ cÃ¡c format string Ä‘Æ¡n giáº£n trong lá»‡nh scanf. Vá»›i 3 chall trÆ°á»›c, format string Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ láº¥y input lÃ  %8s , tuy nhiÃªn chall nÃ y thÃ¬ format string lÃ  â€œ%x %x %xâ€, Angr khÃ´ng chÃ¨n symbol giÃ¹m Ä‘Æ°á»£c.

```python
import angr
 
#create a state
proj=angr.Project("./03_angr_symbolic_registers")
start_addr=0x08048980
state=proj.factory.blank_state(addr=start_addr)
 
#create some symbols
a=state.solver.BVS("a",32)
b=state.solver.BVS("b",32)
d=state.solver.BVS("d",32)
 
#write those symbols to registers
state.regs.eax=a
state.regs.ebx=b
state.regs.edx=d
 
#symbolic execution!!!
simgr=proj.factory.simulation_manager(state)
good=0x080489EE
bad=0x080489DC
simgr.explore(find=good,avoid=bad)
 
if (not simgr.found):
    raise Execption("Something is wrong!")
 
#print the result
result=simgr.found[0]
pass0=hex(result.solver.eval(a))
pass1=hex(result.solver.eval(b))
pass2=hex(result.solver.eval(d))
 
print ("%s %s %s" %(pass0, pass1, pass2))
```

### 04_angr_symbolic_stack

Láº§n nÃ y input khÃ´ng lÆ°u trÃªn thanh ghi ná»¯a mÃ  Ä‘Æ°á»£c Ä‘á»ƒ trong stack. Váº­y thÃ¬ ta sáº½ Ä‘Æ°a symbol vÃ o stack thÃ´i!

Sau khi táº¡o state rá»“i simgr cÃ¡c kiá»ƒu thÃ¬ giá» ta báº¯t Ä‘áº§u xÃ©t Ä‘áº¿n stack. MÃ¬nh chá»n entry cho state lÃ  lá»‡nh â€œmov eax, [ebp+var_C]â€. VÃ¬ nháº£y vÃ o ngay giá»¯a cÃ¡i hÃ m nÃªn chÃºng ta chÆ°a cÃ³ stack frame (do 3 lá»‡nh â€œpush ebpâ€, â€œmov ebp, espâ€,â€sub esp, 18hâ€ Ä‘á»ƒ táº¡o stack frame náº±m á»Ÿ Ä‘áº§u hÃ m), ta pháº£i tá»± táº¡o thÃ´i

```python
state.regs.ebp = state.regs.esp
state.regs.esp -= 0x18
```

NhÃ¬n trong IDA thÃ¬ tháº¥y input Ä‘Æ°á»£c lÆ°u trong 2 Ã´ nhá»› lÃ  [ebp-0xc] vÃ  [ebp-0x10], váº­y giá» mÃ¬nh sáº½ Ä‘áº©y symbol vÃ o 2 Ã´ nÃ y.

```python
ebp=state.solver.eval(state.regs.ebp)
first=state.solver.BVS("first",32sstate.solver.BVS("second",32state.mestate.memory.store(ebp-0xc,first,endness=proj.arch.memory_endness)
state.memory.store(ebp-0x10,second,endness=proj.arch.memory_endness)
```

**Note: ** Theo máº·c Ä‘á»‹nh thÃ¬ lá»‡nh memory.store sáº½ lÆ°u giÃ¡ trá»‹ theo kiá»ƒu â€œbig-endianâ€, do Ä‘Ã³ ta cáº§n pháº£i chá»‰nh láº¡i chá»— nÃ y cho Ä‘Ãºng báº±ng cÃ¡ch thÃªm tham sá»‘ endness (chá»— nÃ y mÃ¬nh ngá»“i cáº£ buá»•i má»›i phÃ¡t hiá»‡n ra ğŸ™‚ , rÃºt kinh nghiá»‡m láº§n sau pháº£i Ä‘á»c document cho ká»¹)

VÃ  pháº§n cÃ²n láº¡i chá»‰ lÃ  explore thÃ´i

```python
good=0x080486E9
bad=0x080486D7
simgr.explore(find=good,avoid=bad)

if (not simgr.found):
     raise Exception("Something is wrong!")

result=simgr.found[0]
first=result.solver.eval(first,cast_to=int)
second=result.solver.eval(second,cast_to=int)
print ("%d %d" %(first, second))
```

**Note:** CÃ³ má»™t cÃ¡ch giáº£i khÃ¡c trong pháº§n solution, cÃ¡ch nÃ y dÃ¹ng lá»‡nh â€œstate.stack_pushâ€. DÃ¹ng lá»‡nh nÃ y thÃ¬ ta khÃ´ng cáº§n quan tÃ¢m endianess, Ä‘á»“ng thá»i cÃ¡ch xá»­ lÃ½ ebp vÃ  esp cÅ©ng hÆ¡i khÃ¡c má»™t chÃºt. (NhÃ¬n chung thÃ¬ khÃ´ng khÃ¡c nhiá»u, note láº¡i Ä‘á»ƒ nhá»› lá»‡nh stack_push thÃ´i ğŸ˜€ )

### 05_angr_symbolic_memory

CÅ©ng nhÆ° bÃ i trÆ°á»›c, nhÆ°ng láº§n nÃ y dá»… hÆ¡n vÃ¬ input Ä‘Æ°á»£c lÆ°u vÃ o trong global variable, mÃ  cÃ¡c biáº¿n nÃ y thÃ¬ cÃ³ Ä‘á»‹a chá»‰ xÃ¡c Ä‘á»‹nh.

### 06_angr_symbolic_dynamic_memory

Láº§n nÃ y thÃ¬ binary sáº½ táº¡o 2 vÃ¹ng nhá»› Ä‘á»™ng rá»“i lÆ°u input trÃªn Ä‘Ã³, Ä‘iá»u nÃ y khiáº¿n cho cÃ¡ch cá»§a bÃ i 5 khÃ´ng lÃ m Ä‘Æ°á»£c vÃ¬ ta chá»‰ biáº¿t Ä‘Æ°á»£c Ä‘á»‹a chá»‰ cá»§a 2 vÃ¹ng nhá»› vÃ o runtime.

Tuy nhiÃªn nhÃ¬n vÃ o IDA thÃ¬ ta tháº¥y ráº±ng Ä‘á»‹a chá»‰ cá»§a 2 vÃ¹ng nhá»› Ä‘á»™ng sáº½ Ä‘Æ°á»£c lÆ°u trong 2 biáº¿n global Ä‘Ã£ biáº¿t Ä‘á»‹a chá»‰. Váº­y Ã½ tÆ°á»Ÿng giáº£i bÃ i nÃ y sáº½ lÃ  lÆ°u 2 Ä‘á»‹a chá»‰ do mÃ¬nh chá»n vÃ o cÃ¡c biáº¿n global: buffer0 vÃ  buffer1, tiáº¿p Ä‘Ã³ Ä‘Æ°a 2 symbol vÃ o 2 Ä‘á»‹a chá»‰ trÃªn.

Full script nhÆ° sau:

```python
import angr
 
proj=angr.Project("./06_angr_symbolic_dynamic_memory")
entry=0x08048687
state=proj.factory.blank_state(addr=entry)
simgr=proj.factory.simulation_manager(state)
 
 
#initialize stack frame
state.regs.ebp=state.regs.esp 
state.regs.esp -=0x10
 
#set the address of 2 buffer
buffer0=0x10000000
buffer1=0x20000000
state.memory.store(0x0ABCC8A4,buffer0,endness=proj.arch.memory_endness)
state.memory.store(0x0ABCC8AC,buffer1,endness=proj.arch.memory_endness)
 
sym0=state.solver.BVS("sym0",64)
sym1=state.solver.BVS("sym1",64)
 
#the symbols are strings so no need for endness argument
state.memory.store(buffer0,sym0)
state.memory.store(buffer1,sym1)
 
good=0x08048759
bad=0x08048747
simgr.explore(find=good,avoid=bad)
 
if (not simgr.found):
    raise Exception("Something is wrong")
 
result=simgr.found[0]
flag0=result.solver.eval(sym0,cast_to=bytes).decode("utf-8")
flag1=result.solver.eval(sym1,cast_to=bytes).decode("utf-8")
print ("%s %s" %(flag0,flag1))
```

### 08_angr_constraints

Binary láº¥y input, encode, sau Ä‘Ã³ cho vÃ o hÃ m Ä‘á»ƒ check.

VÃ o hÃ m Ä‘Ã³ xem thÃ¬ tháº¥y nÃ³ so sÃ¡nh tá»«ng char cá»§a input sau khi encode vá»›i tá»«ng chá»¯ trong string â€œAUPDNNPROEZRJWKBâ€. Váº­y lÃ  ta cÃ³ má»™t vÃ²ng láº·p 16 láº§n, náº¿u Ä‘á»ƒ angr thá»­ háº¿t táº¥t cáº£ cÃ¡c trÆ°á»ng há»£p thÃ¬ hÆ¡i lÃ¢u, vÃ¬ tháº¿ nÃªn bÃ i nÃ y ta sáº½ dá»«ng ngay trÆ°á»›c lá»‡nh call (tá»©c khÃ´ng gá»i hÃ m so sÃ¡nh), sau Ä‘Ã³ add constraint vÃ o báº±ng tay. (LÆ°u Ã½ lÃ  sau khi dá»«ng chÆ°Æ¡ng trÃ¬nh Ä‘á»ƒ thÃªm constraint thÃ¬ ta khÃ´ng cho cháº¡y tiáº¿p ná»¯a, do Ä‘Ã³ á»Ÿ Ä‘Ã¢y khÃ´ng cÃ³ Ä‘oáº¡n find vá»›i avoid)

```python
import angr
 
proj=angr.Project("./08_angr_constraints")
entry=0x08048625
state=proj.factory.blank_state(addr=entry)
simgr=proj.factory.simulation_manager(state)
 
#add symbol to buffer 
password=state.solver.BVS("password",16*8)
buffer_addr=0x0804A050
state.memory.store(buffer_addr,password)
 
#stop before the check function 
check_addr=0x08048673
simgr.explore(find=check_addr)
if (not simgr.found):
    raise Exception("Wrong!")
 
result=simgr.found[0]
complex_pass=result.memory.load(buffer_addr,16)
result.solver.add(complex_pass=="AUPDNNPROEZRJWKB") #add 1 constraint
password=result.solver.eval(password,cast_to=bytes)
print (password)
```
### 09_angr_hooks

BÃ i nÃ y cÅ©ng giá»‘ng nhÆ° bÃ i trÆ°á»›c, tuy nhiÃªn cÃ³ má»™t Ä‘iá»ƒm khÃ¡c khiáº¿n cho viá»‡c add constraint báº±ng tay trá»Ÿ nÃªn kÃ©m hiá»‡u quáº£ hÆ¡n

Sau hÃ m check string dÃ i dÃ i kia thÃ¬ chÆ°Æ¡ng trÃ¬nh cÃ²n 1 láº§n check ná»¯a. Náº¿u ta dá»«ng láº¡i trÆ°á»›c hÃ m â€œcheck_equalâ€¦â€ rá»“i thÃªm constraint báº±ng tay thÃ¬ sáº½ bá» máº¥t Ä‘oáº¡n sau. ChÃ­nh vÃ¬ tháº¿ ta sáº½ dÃ¹ng Ä‘áº¿n hook, má»™t cÃ´ng cá»¥ cá»§a Angr cho phÃ©p ta thay má»™t hay nhiá»u cÃ¢u lá»‡nh trong binary báº±ng má»™t hÃ m trong python do ngÆ°á»i dÃ¹ng viáº¿t.

Cáº¥u trÃºc lá»‡nh:

```python
@proj.hook(<addr>,length=<>)
hooker(state): #hÃ m Ä‘Æ°á»£c thay
```
TÃ¡c dá»¥ng nhÆ° sau: khi chÆ°Æ¡ng trÃ¬nh thá»±c thi tá»›i lá»‡nh á»Ÿ Ä‘á»‹a chá»‰ <addr>, nÃ³ sáº½ dá»«ng láº¡i vÃ  cháº¡y hÃ m <hooker> ( ğŸ™‚ ) cá»§a chÃºng ta, sau Ä‘Ã³ sáº½ bá» qua <n> byte káº¿ tiáº¿p (lÆ°u Ã½ lÃ  bá» n byte chá»© khÃ´ng pháº£i bá» n lá»‡nh)

Vá»›i bÃ i nÃ y thÃ¬ mÃ¬nh muá»‘n chÆ°Æ¡ng trÃ¬nh khÃ´ng thá»±c hiá»‡n hÃ m check_equal mÃ  sáº½ cháº¡y hÃ m cá»§a mÃ¬nh. Do dÃ³ mÃ¬nh nháº­p tham sá»‘ addr lÃ  Ä‘á»‹a chá»‰ ngay chá»— gá»i hÃ m check_equal, length thÃ¬ cÃ³ thá»ƒ má»Ÿ ida lÃªn lÃ  tÃ­nh Ä‘Æ°á»£c. Váº­y giá» chá»‰ cáº§n quan tÃ¢m xem hÃ m hooker sáº½ lÃ m gÃ¬ thÃ´i.

NhÃ¬n vÃ o IDA má»™t láº§n ná»¯a, ta tháº¥y giÃ¡ trá»‹ tráº£ vá» cá»§a hÃ m check_equal Ä‘Æ°á»£c lÆ°u vÃ o eax. Ok, váº­y Ä‘Ã¢y sáº½ lÃ  hooker cá»§a mÃ¬nh

```python
@proj.hook(0x080486A9,length=15)
def hooker(state):
    passwd_buffer=state.memory.load(0x0804A054,16)
    state.regs.eax = state.solver.If(passwd_buffer=="XYMKBKUHNIQYNQXE",state.solver.BVV(1statstate.solver.BVV(0, 32))
```
**Note:** ÄÃ¢y lÃ  má»™t sá»‘ Ä‘iá»u mÃ¬nh rÃºt ra sau khi viáº¿t hÃ m nÃ y:
  â€“ Lá»‡nh state.solver.If(â€¦.) thá»ƒ hiá»‡n má»™t má»‡nh Ä‘á» if-then-else vÃ  nÃ³ khÃ´ng tÆ°Æ¡ng Ä‘Æ°Æ¡ng vá»›i viá»‡c viáº¿t
  ```python
  if state.solver.is_true(passwd_buffer=="XYMKBKUHNIQYNQXE"):
     state.regs.eax=state.solver.BVV(1, 32)
  ```
  - KhÃ´ng thá»ƒ thay tháº¿ ***state.solver.BVV(1,32)*** vÃ  ***state.solver.BVV(0,32)*** báº±ng 1 vÃ  0 Ä‘Æ°á»£c. LÃ½ do thÃ¬ mÃ¬nh chÆ°a biáº¿t ğŸ™‚ (cháº¯c pháº£i nghÃ­a qua claripy má»™t chÃºt)
  
### 12_angr_veritesting
Veritesting lÃ  má»™t thuáº­t toÃ¡n dÃ¹ng Ä‘á»ƒ gá»™p cÃ¡c nhÃ¡nh ráº½ trong luá»“ng thá»±c thi, giÃºp cho symbolic execution Ä‘á»¡ tá»‘n thá»i gian hÆ¡n. Äá»ƒ enable veritesting thÃ¬ khi táº¡o simulation manager, ta chá»‰ cáº§n:

```python
simulation = project.factory.simgr(initial_state, veritesting=True)
```

BÃ i nÃ y thá»±c ra y há»‡t nhÆ° bÃ i trÃªn. Tuy nhiÃªn nhá» veritesting gá»™p nhÃ¡nh vÃ  lÃ m Ä‘Æ¡n giáº£n hÃ m nÃªn ta khÃ´ng pháº£i code hÃ m Ä‘á»ƒ hook ná»¯a.
