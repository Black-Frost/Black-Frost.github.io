<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>Rootme challenge - SEHVEH - Frost's blog</title><meta name=Description content><meta property="og:title" content="Rootme challenge - SEHVEH"><meta property="og:description" content="Kể ra thì từ khi tạo blog đến giờ mình chưa viết được bài nào ra hồn cả. Mấy tuần trước mình đã có dự định là sau khi thi xong sẽ bắt đầu việc viết lách, thế nhưng rốt cục bệnh lười lại tái phát. Mãi đến hôm nay, sau một hồi đấu tranh với cái tính nhác việc, mình mới chịu mở lap lên và ngồi lọc cọc gõ ra bài này."><meta property="og:type" content="article"><meta property="og:url" content="/posts/old_posts/2020-09-11-sehveh/"><meta property="og:image" content="/images/slime-attack.gif"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-09-11T00:00:00+00:00"><meta property="article:modified_time" content="2020-09-11T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/images/slime-attack.gif"><meta name=twitter:title content="Rootme challenge - SEHVEH"><meta name=twitter:description content="Kể ra thì từ khi tạo blog đến giờ mình chưa viết được bài nào ra hồn cả. Mấy tuần trước mình đã có dự định là sau khi thi xong sẽ bắt đầu việc viết lách, thế nhưng rốt cục bệnh lười lại tái phát. Mãi đến hôm nay, sau một hồi đấu tranh với cái tính nhác việc, mình mới chịu mở lap lên và ngồi lọc cọc gõ ra bài này."><meta name=application-name content="LoveIt"><meta name=apple-mobile-web-app-title content="LoveIt"><link rel="shortcut icon" type=image/x-icon href=../../../favicon.ico><link rel=icon type=image/png sizes=32x32 href=../../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../../favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=../../../apple-touch-icon.png><link rel=manifest href=../../../site.webmanifest><link rel=canonical href=../../../posts/old_posts/2020-09-11-sehveh/><link rel=prev href=../../../posts/old_posts/2020-07-07-angstrom-2020/><link rel=next href=../../../posts/old_posts/2021-06-19-flareon6-chall7-log/><link rel=stylesheet href=../../../lib/normalize/normalize.min.css><link rel=stylesheet href=../../../css/style.min.css><link rel=stylesheet href=../../../lib/fontawesome-free/all.min.css><link rel=stylesheet href=../../../lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Rootme challenge - SEHVEH","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"\/posts\/old_posts\/2020-09-11-sehveh\/"},"genre":"posts","keywords":"learning, rootme, writeup","wordcount":1111,"url":"\/posts\/old_posts\/2020-09-11-sehveh\/","datePublished":"2020-09-11T00:00:00+00:00","dateModified":"2020-09-11T00:00:00+00:00","publisher":{"@type":"Organization","name":"Frost"},"author":{"@type":"Person","name":"Frost"},"description":""}</script></head><body header-desktop header-mobile><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"dark"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"dark"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=../../../ title="Frost's blog"><img class="lazyload logo" src=../../../svg/loading.min.svg data-src=../../../images/slime-attack.gif data-srcset="../../../images/slime-attack.gif, ../../../images/slime-attack.gif 1.5x, ../../../images/slime-attack.gif 2x" data-sizes=auto alt=/images/slime-attack.gif title=/images/slime-attack.gif></a></div><div class=menu><div class=menu-inner><a class=menu-item href=../../../posts/>Posts </a><a class=menu-item href=../../../tags/>Tags </a><a class=menu-item href=../../../about/>About </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=../../../ title="Frost's blog"><img class="lazyload logo" src=../../../svg/loading.min.svg data-src=../../../images/slime-attack.gif data-srcset="../../../images/slime-attack.gif, ../../../images/slime-attack.gif 1.5x, ../../../images/slime-attack.gif 2x" data-sizes=auto alt=/images/slime-attack.gif title=/images/slime-attack.gif></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=../../../posts/ title>Posts</a><a class=menu-item href=../../../tags/ title>Tags</a><a class=menu-item href=../../../about/ title>About</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">Rootme challenge - SEHVEH</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=../../../ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>Frost</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2020-09-11>2020-09-11</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;1111 words&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;6 minutes&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><ul><li><a href=#1-exception>1. Exception:</a></li><li><a href=#2-seh-và-veh>2. SEH và VEH:</a></li><li><a href=#3-writeup>3. Writeup:</a></li></ul></li></ul></nav></div></div><div class=content id=content><p>Kể ra thì từ khi tạo blog đến giờ mình chưa viết được bài nào ra hồn cả. Mấy tuần trước mình đã có dự định là sau khi thi xong sẽ bắt đầu việc viết lách, thế nhưng rốt cục bệnh lười lại tái phát. Mãi đến hôm nay, sau một hồi đấu tranh với cái tính nhác việc, mình mới chịu mở lap lên và ngồi lọc cọc gõ ra bài này.</p><p>Dạo này việc học của mình không có tiến bộ gì mấy (khá thất vọng vì điều này), tất cả những gì mình làm trong vài tuần vừa qua chỉ là giải bài trên Root-me mà thôi. Root-me là một trang web rất thích hợp cho những newbie mới tập chơi CTF như mình. Những chall mình giải được cung cấp cho mình một vài kiến thức mới mà mình thấy đáng phải ghi lại, và sau đây là một trong số đó.</p><p>Dài dòng thế là đủ rồi, chào mừng đến với bài viết của mình về <strong>Structured Exception Handling</strong>. Trong bài viết này mình sẽ trình bày writeup cho challenge <strong>SEHVEH</strong> của Root-me, đồng thời nêu những khái niệm mới mà mình học được trong quá trình giải bài.</p><h3 id=1-exception>1. Exception:</h3><p>Trước khi đi vào writeup, mình muốn nói sơ qua một chút về exception. Theo định nghĩa từ <em><a href=https://docs.microsoft.com/ target=_blank rel="noopener noreffer">https://docs.microsoft.com/</a></em>, exception là một sự kiện xảy ra trong quá trình chạy chương trình. Những sự kiện này buộc chương trình phải thực hiện các đoạn code nằm bên ngoài luồng thực thi thông thường.</p><p>Ta lấy một ví dụ như sau:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;iostream&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>a</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>cin</span> <span class=o>&gt;&gt;</span> <span class=n>a</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=mi>10</span><span class=o>/</span><span class=n>a</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Ở chương trình trên, nếu nhập input là 0, ta dễ dàng nhận thấy có một phép toán không hợp lệ (phép chia cho 0). Lúc này chương trình sẽ thông báo lỗi và dừng lại. Vậy tức là trong quá trình thực thi, đã có một exception khiến cho chương trình không chạy như bình thường mà phải thực hiện một đoạn code khác có nhiệm vụ in lỗi và thoát chương trình.</p><h3 id=2-seh-và-veh>2. SEH và VEH:</h3><p><strong>Structure Exception Handling</strong> (hay SEH) là một cơ chế để xử lý các exception. Nhờ cơ chế này mà chúng ta có thể kiểm soát được cách mà chương trình của mình giải quyết các exception. Còn <strong>Vectored Exception Handling</strong> (hay VEH) thực chất là một phần của SEH. VEH cho phép chúng ta chỉ định một hàm để xử lý toàn bộ các exception xảy ra trong quá trình thực thi. Trong Windows, ta có thể sử dụng hàm <strong>AddVectoredExceptionHandler</strong> để thêm handler cho chương trình.</p><p>Đề bài tên là <strong>SEHVEH</strong> nên chắc hẳn sẽ dính đến hai khái niệm này rồi. Bây giờ thì bắt tay vào giải thôi.</p><h3 id=3-writeup>3. Writeup:</h3><p>OK, bây giờ chúng ta cũng đi vào writeup nào.
<img class=lazyload src=../../../svg/loading.min.svg data-src=../assets/img/seh/2020-08-03-seh_1.png data-srcset="../assets/img/seh/2020-08-03-seh_1.png, ../assets/img/seh/2020-08-03-seh_1.png 1.5x, ../assets/img/seh/2020-08-03-seh_1.png 2x" data-sizes=auto alt=../assets/img/seh/2020-08-03-seh_1.png title=../assets/img/seh/2020-08-03-seh_1.png>{: .mx-auto.d-block :}</p><p>Nhìn vào hàm <strong>start</strong>, ta nhận thấy sau khi nhận input bằng <em>scanf</em>, chương trình đưa địa chỉ của một hàm nào đó vào ecx, sau đó tiến hành gọi lệnh <strong>call ecx</strong> (trong hình mình có đặt tên cho nó là <em>check</em>)</p><p>Hàm <strong>check</strong> đương nhiên có nhiệm vụ là&mldr; kiểm tra input của chúng ta rồi. Vậy giờ hãy đi vào phân tích hàm này.</p><p>Dựa vào graph của ida, có vẻ như hàm <strong>check</strong> có 4 phần kiểm tra riêng biệt. Nếu input của ta rớt test nào thì lập tức <em>ebp</em> sẽ nhảy lên 1. Vậy mục tiêu của ta là giữ cho ebp nằm ở số 0 thôi!</p><p><img class=lazyload src=../../../svg/loading.min.svg data-src=../assets/img/seh/2020-08-03-seh_2.png data-srcset="../assets/img/seh/2020-08-03-seh_2.png, ../assets/img/seh/2020-08-03-seh_2.png 1.5x, ../assets/img/seh/2020-08-03-seh_2.png 2x" data-sizes=auto alt=../assets/img/seh/2020-08-03-seh_2.png title=../assets/img/seh/2020-08-03-seh_2.png>{: .mx-auto.d-block :}</p><p>Sử dụng debugger (hay phân tích tĩnh cũng được), ta nhận thấy đoạn code trên dùng để kiểm tra độ dài của input. Phần check này khá dễ nên mình sẽ không ghi ở đây.</p><p><img class=lazyload src=../../../svg/loading.min.svg data-src=../assets/img/seh/2020-08-03-seh_3.png data-srcset="../assets/img/seh/2020-08-03-seh_3.png, ../assets/img/seh/2020-08-03-seh_3.png 1.5x, ../assets/img/seh/2020-08-03-seh_3.png 2x" data-sizes=auto alt=../assets/img/seh/2020-08-03-seh_3.png title=../assets/img/seh/2020-08-03-seh_3.png>{: .mx-auto.d-block :}</p><p>Đoạn này cũng đơn giản luôn nè, chỉ là xor thôi.</p><p><img class=lazyload src=../../../svg/loading.min.svg data-src=../assets/img/seh/2020-08-03-seh_4.png data-srcset="../assets/img/seh/2020-08-03-seh_4.png, ../assets/img/seh/2020-08-03-seh_4.png 1.5x, ../assets/img/seh/2020-08-03-seh_4.png 2x" data-sizes=auto alt=../assets/img/seh/2020-08-03-seh_4.png title=../assets/img/seh/2020-08-03-seh_4.png>{: .mx-auto.d-block :}</p><p>Ở đây xuất hiện 3 instruction khá lạ như sau</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=nf>push</span>    <span class=no>ebx</span>
</span></span><span class=line><span class=cl><span class=nf>push</span>    <span class=no>large</span> <span class=no>dword</span> <span class=no>ptr</span> <span class=no>fs</span><span class=p>:</span><span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=nf>mov</span>     <span class=no>large</span> <span class=no>fs</span><span class=p>:</span><span class=mi>0</span><span class=p>,</span> <span class=no>esp</span>
</span></span></code></pre></td></tr></table></div></div><p>Đối với các chương trình trên Windows, thanh ghi <strong>fs</strong> dùng để chỉ tới <strong>Thread Information Block</strong> (TIB). Từ tên gọi, ta cũng đoán được đây là một cấu trúc dữ liệu lưu những thông tin về thread đang chạy, và một trong số những thông tin đó chính là <em>SEH frame</em> (tham khảo tại [đây]
(<a href=https://en.wikipedia.org/wiki/Win32_Thread_Information_Block#Accessing_the_TIB%29%29 target=_blank rel="noopener noreffer">https://en.wikipedia.org/wiki/Win32_Thread_Information_Block#Accessing_the_TIB))</a>.</p><p>Nói về <em>SEH frame</em> thì đó là nơi lưu trữ địa chỉ của các exception handler, cách mà chương trình tìm đến handler phù hợp được mô tả theo lưu đồ sau (quá trình này được gọi là <a href=https://www.geeksforgeeks.org/stack-unwinding-in-c/ target=_blank rel="noopener noreffer">Stack Unwinding</a>
<img class=lazyload src=../../../svg/loading.min.svg data-src=../assets/img/2020-8-3-seh/seh_flowchart.png data-srcset="../assets/img/2020-8-3-seh/seh_flowchart.png, ../assets/img/2020-8-3-seh/seh_flowchart.png 1.5x, ../assets/img/2020-8-3-seh/seh_flowchart.png 2x" data-sizes=auto alt=../assets/img/2020-8-3-seh/seh_flowchart.png title=../assets/img/2020-8-3-seh/seh_flowchart.png>{: .mx-auto.d-block :}</p><p>Dựa vào cấu trúc của TIB, ta nhận thấy <strong>fs:0</strong> chính là pointer trỏ đến <em>SEH frame</em>. Mỗi địa chỉ của một handler được lưu dưới dạng struct <strong>EXCEPTION_REGISTRATION_RECORD</strong> (tham khảo thêm về cấu trúc tại <a href=https://www.nirsoft.net/kernel_struct/vista/EXCEPTION_REGISTRATION_RECORD.html target=_blank rel="noopener noreffer">đây</a>). Chính vì thế, 2 lệnh push ở trên thực chất là đưa thêm một struct <strong>EXCEPTION_REGISTRATION_RECORD</strong>, hay nói cách khác, địa chỉ của một handler vào stack. Tiếp đó, lệnh mov sẽ thay đổi địa chỉ mà <strong>fs:0</strong> trỏ tới, tức là thay đổi cái handler đầu tiên được gọi.</p><p>Nói tóm gọn lại, khi gặp exception trong chương trình, đầu tiên OS sẽ đến địa chỉ nằm trong <strong>fs:0</strong> và gọi hàm ở đó. Nếu exception chưa được giải quyết, nó sẽ tìm đến hàm tiếp theo được trỏ đến bởi phần tử <em>next</em> trong struct <strong>EXCEPTION_REGISTRATION_RECORD</strong> và cứ tiếp tục như thế cho đến khi thỏa mãn exception (nhắc lại một lần nữa đây là stack unwinding nha :D ).</p><p>Sau khi thêm handler vô rồi thì ta có thể thấy chương trình tạo exception ngay phía dưới với lệnh <strong>int 1</strong>, với kiến thức đã nói ở trên thì ta có thể dễ dàng xử lý điều này (bằng cách debug hay tìm tới địa chỉ của hàm handler vừa được thêm vô rồi đọc code đều được)</p><p>Đoạn check cuối cũng thêm một handler vào, nhưng thêm bằng hàm <strong>AddVectoredExceptionHandler</strong> của WinApi. Về cơ bản thì hàm này làm nhiệm vụ y hệt với 3 instruction ở trên, vậy nên ta cũng xử lý giống ở trên luôn. (Một lưu ý nhỏ, hãy nhớ rằng nếu exception chưa được giải quyết, chương trình sẽ tìm đến hàm tiếp theo trong danh sách handler, do đó nếu phân tích tĩnh thì nên chú ý xem hàm này đã làm thỏa exception chưa)</p><p>Thôi viết thế đủ rồi nhỉ, mình cũng lười quá rôi. Bắt đầu viết từ đầu tháng mà ngâm đến cuối tháng mới xong :(</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2020-09-11</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=../../../tags/learning/>learning</a>,&nbsp;<a href=../../../tags/rootme/>rootme</a>,&nbsp;<a href=../../../tags/writeup/>writeup</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=../../../>Home</a></span></section></div><div class=post-nav><a href=../../../posts/old_posts/2020-07-07-angstrom-2020/ class=prev rel=prev title="A week with Angstromctf 2020"><i class="fas fa-angle-left fa-fw"></i>A week with Angstromctf 2020</a>
<a href=../../../posts/old_posts/2021-06-19-flareon6-chall7-log/ class=next rel=next title="Flareon 6 - challenge 7 (Wopr) solving log">Flareon 6 - challenge 7 (Wopr) solving log<i class="fas fa-angle-right fa-fw"></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.117.0">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2025</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=../../../ target=_blank>Frost</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw"></i></a></div><script type=text/javascript src=../../../lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=../../../lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=../../../lib/clipboard/clipboard.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:100},comment:{}}</script><script type=text/javascript src=../../../js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-CY316V8Z0V")</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-CY316V8Z0V" async></script></body></html>