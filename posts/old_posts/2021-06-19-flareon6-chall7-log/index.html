<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>Flareon 6 - challenge 7 (Wopr) solving log - Frost's blog</title><meta name=Description content><meta property="og:title" content="Flareon 6 - challenge 7 (Wopr) solving log"><meta property="og:description" content="So because of my laziness, this blog has beed collecting dust for almost a year now. And since I&rsquo;m solving some Flareon challenges from the last years, I figure it would be a good time to post some write up. But I&rsquo;m too lazy to write a proper writeup (and also there are so many writeups of those challs already), I&rsquo;m just gonna post a log of the things I did solving the challenge so that I can look back at it later when I need to."><meta property="og:type" content="article"><meta property="og:url" content="/posts/old_posts/2021-06-19-flareon6-chall7-log/"><meta property="og:image" content="/images/logo.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-06-19T00:00:00+00:00"><meta property="article:modified_time" content="2021-06-19T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/images/logo.jpg"><meta name=twitter:title content="Flareon 6 - challenge 7 (Wopr) solving log"><meta name=twitter:description content="So because of my laziness, this blog has beed collecting dust for almost a year now. And since I&rsquo;m solving some Flareon challenges from the last years, I figure it would be a good time to post some write up. But I&rsquo;m too lazy to write a proper writeup (and also there are so many writeups of those challs already), I&rsquo;m just gonna post a log of the things I did solving the challenge so that I can look back at it later when I need to."><meta name=application-name content="LoveIt"><meta name=apple-mobile-web-app-title content="LoveIt"><link rel="shortcut icon" type=image/x-icon href=../../../favicon.ico><link rel=icon type=image/png sizes=32x32 href=../../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../../favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=../../../apple-touch-icon.png><link rel=manifest href=../../../site.webmanifest><link rel=canonical href=../../../posts/old_posts/2021-06-19-flareon6-chall7-log/><link rel=prev href=../../../posts/old_posts/2020-09-11-sehveh/><link rel=next href=../../../posts/redpwn2021/><link rel=stylesheet href=../../../lib/normalize/normalize.min.css><link rel=stylesheet href=../../../css/style.min.css><link rel=stylesheet href=../../../lib/fontawesome-free/all.min.css><link rel=stylesheet href=../../../lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Flareon 6 - challenge 7 (Wopr) solving log","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"\/posts\/old_posts\/2021-06-19-flareon6-chall7-log\/"},"genre":"posts","keywords":"ctf, flareon, log","wordcount":958,"url":"\/posts\/old_posts\/2021-06-19-flareon6-chall7-log\/","datePublished":"2021-06-19T00:00:00+00:00","dateModified":"2021-06-19T00:00:00+00:00","publisher":{"@type":"Organization","name":"Frost"},"author":{"@type":"Person","name":"Frost"},"description":""}</script></head><body header-desktop header-mobile><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"dark"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"dark"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=../../../ title="Frost's blog"><img class="lazyload logo" src=../../../svg/loading.min.svg data-src=../../../images/logo.jpg data-srcset="../../../images/logo.jpg, ../../../images/logo.jpg 1.5x, ../../../images/logo.jpg 2x" data-sizes=auto alt=/images/logo.jpg title=/images/logo.jpg></a></div><div class=menu><div class=menu-inner><a class=menu-item href=../../../posts/>Posts </a><a class=menu-item href=../../../tags/>Tags </a><a class=menu-item href=../../../about/>About </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=../../../ title="Frost's blog"><img class="lazyload logo" src=../../../svg/loading.min.svg data-src=../../../images/logo.jpg data-srcset="../../../images/logo.jpg, ../../../images/logo.jpg 1.5x, ../../../images/logo.jpg 2x" data-sizes=auto alt=/images/logo.jpg title=/images/logo.jpg></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=../../../posts/ title>Posts</a><a class=menu-item href=../../../tags/ title>Tags</a><a class=menu-item href=../../../about/ title>About</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">Flareon 6 - challenge 7 (Wopr) solving log</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=../../../ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>Frost</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2021-06-19>2021-06-19</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;958 words&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;5 minutes&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><ul><li><a href=#challenge-info>Challenge info</a></li><li><a href=#solving-log>Solving log:</a></li></ul></li></ul></nav></div></div><div class=content id=content><p>So because of my laziness, this blog has beed collecting dust for almost a year now. And since I&rsquo;m solving some Flareon challenges from the last years, I figure it would be a good time to post some write up. But I&rsquo;m too lazy to write a proper writeup (and also there are so many writeups of those challs already), I&rsquo;m just gonna post a log of the things I did solving the challenge so that I can look back at it later when I need to.</p><h3 id=challenge-info>Challenge info</h3><ul><li><strong>Given files:</strong> <a href=assets/binary/2021-06-19-flareon6-chall7-log/wopr.exe rel>wopr.exe</a></li><li><strong>Description:</strong> <code>We used our own computer hacking skills to "find" this AI on a military supercomputer. It does strongly resemble the classic 1983 movie WarGames. Perhaps life imitates art? If you can find the launch codes for us, we'll let you pass to the next challenge. We promise not to start a thermonuclear war.</code></li><li><strong>Summary:</strong> A CLI game written in Python and compiled using PyInstaller. We need to find the correct key to get the flag.</li></ul><h3 id=solving-log>Solving log:</h3><ul><li>Use pyinstxtractor to extract pyc</li><li>Didn&rsquo;t notice the entry points proposed by pyinstxtractor.</li><li>Has to read a tiny bit from a wu online] to know which pyc file is the entry point (that guy made the same mistake as I did).</li><li>Can&rsquo;t decompile using uncompyle6</li><li>Get version of python using magic bytes of pyc: <a href=https://fossies.org/linux/file/magic/Magdir/python target=_blank rel="noopener noreffer">https://fossies.org/linux/file/magic/Magdir/python</a></li><li>Know that this is from python 3.8 (magic: <code>0x550d0d0a</code>)</li><li>Learn about decompyle3 (another decompiler focusing on python 3.7+): <a href=https://stackoverflow.com/questions/5287253/is-it-possible-to-decompile-a-compiled-pyc-file-into-a-py-file target=_blank rel="noopener noreffer">https://stackoverflow.com/questions/5287253/is-it-possible-to-decompile-a-compiled-pyc-file-into-a-py-file</a></li><li>Great. decompyle3 also fails.</li><li>The <code>dis</code> module works fine, so it&rsquo;s not one of those opcode remap challenge that I met earlier in another ctf. (how to diassemble pyc file: <a href=https://stackoverflow.com/questions/59431770/why-cant-python-dis-module-disassembly-this-pyc-file target=_blank rel="noopener noreffer">https://stackoverflow.com/questions/59431770/why-cant-python-dis-module-disassembly-this-pyc-file</a>)</li><li>So here&rsquo;s the thing: detect-it-easy is able to recognize pyimod02_archive.pyc and pyimod03_importers.pyc. Those 2 file also decompile-able and their headers are different from pyiboot02_cleanup.pyc (which is the predicted entry point)</li><li>pyimod02_archive.pyc&rsquo;s header says that it is from python 3.7, while pyiboot02_cleanup.pyc is from 3.8. Is it even possible that 2 file are written using different version of python?</li><li>The reasonable things to do now is to modify the header of pyiboot02_cleanup.pyc to match that of pyimod02_archive.pyc.</li><li>From <a href=https://stackoverflow.com/questions/59431770/why-cant-python-dis-module-disassembly-this-pyc-file target=_blank rel="noopener noreffer">this question</a> I know that the header is 16 bytes. So time to fix.</li><li>And it works!!!!!!!!!!!!</li><li>If we run the decompiled script, it prints a poem that wasn&rsquo;t there when the exe runs.</li><li>The script also fails at BOUNCE = pkgutil.get_data(&rsquo;this&rsquo;, &lsquo;key&rsquo;)</li><li>About package in Python: <a href="https://www.python-course.eu/python3_packages.php#:~:text=A%20package%20is%20basically%20a,several%20modules%20into%20a%20Package" target=_blank rel="noopener noreffer">https://www.python-course.eu/python3_packages.php#:~:text=A%20package%20is%20basically%20a,several%20modules%20into%20a%20Package</a>.</li><li>How does Python find package: <a href=https://leemendelowitz.github.io/blog/how-does-python-find-packages.html target=_blank rel="noopener noreffer">https://leemendelowitz.github.io/blog/how-does-python-find-packages.html</a></li><li>So I just need to copy the <code>this</code> package folder to the same folder that has the script and everything is fine.</li><li>So far, the only thing I know about this program is that it swaps exec() with print()</li><li>The loop with lzma.decompress() always fails, what the heck? It decode something using <code>__doc__</code>. So did I mess something up in that?</li><li>Hiding code using tabs and spaces from <code>__doc__</code>, this is new. But it seems like my text editor (or maybe uncompyle6) has messed up the tabs (all tabs are converted to spaces). Luckily, I found out that we can dump the <code>__doc__</code> straight from the pyc file. (I can still see the tabs in the hex dump so this might work)</li><li>Also in this post, the guy explains about <code>__doc__</code> : <a href=https://stackoverflow.com/questions/1983177/are-python-docstrings-and-comments-stored-in-memory-when-a-module-is-loaded target=_blank rel="noopener noreffer">https://stackoverflow.com/questions/1983177/are-python-docstrings-and-comments-stored-in-memory-when-a-module-is-loaded</a></li><li>Just checked, uncompyle6 is the culprit</li><li>Ok, I just copy-paste the correct string using dis.code_info() from the terminal (Spent hours trying to do that using regex but to no avail)</li><li>Is the fire() function rc4??</li><li>I&rsquo;m 80% sure that fire() is rc4, but knowing that helps me nothing. The script still doesn&rsquo;t run.</li><li>Ok, copying the <strong>doc</strong> from the terminal still messes up the text. Last resort, dump it all out!</li><li>We can see the text kinda clearly inside a hex editor, hope that I dont miss any tabs or spaces though.</li><li>With i = 74, the exception in the loop is different, lzma no longer fails to decode the text, maybe we have the source now.</li><li>Ok I got the hidden source code.</li><li>The wrong() function is used to generate the correct launch code. It seems to do something
with the PE header.</li><li>The code does something with the relocation table, an article about that: <a href=https://research32.blogspot.com/2015/01/base-relocation-table.html target=_blank rel="noopener noreffer">https://research32.blogspot.com/2015/01/base-relocation-table.html</a></li><li>I think that it is trying to calculate md5 hash of the .text section</li><li>The wrong() function first performing an un-reloc routine (that is getting every address and turning them back into relative offset) &ndash;> I think this is to get the original binary data before the program got loaded in memory. It then calculates md5 hash of said data.</li><li>We have what we needed, now all that left to do is find the flag using some z3 (or claripy).</li><li>Problem: the preferred address of the binary is 0x400000 something, while the opcode used to calculate md5 hash must use the base address of 0. I really don&rsquo;t want to rebase by hand.</li><li>So what I think I&rsquo;m gonna do is load the binary to ida, let it rebase for me, then dump the .text section out to a new file.</li><li>Got the hidden source code. We&rsquo;re moving on!</li><li>It seems like I got the key.</li><li>Nope! The result is printable, but still not the key.</li><li>Oh wait, it&rsquo;s just z3 being difficult. I thought the Decls() function returns all symbols in
the order they are created. Well, now I know.</li><li>Now we&rsquo;re talking. the code is correct.</li><li>And here&rsquo;s the flag: <code>L1n34R_4L93bR4_i5_FuN@flare-on.com</code></li></ul><hr><p>Epilouge: So it turns out that the weird poem I encountered earlier is a part of pkgutil.get_data()</p><p><strong>P/s:</strong> I just read the whole post all over again. This log is a bad idea, there are some details that I forgot to write down when I was working on the challenge. Guess I have to write a proper writeup then.</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2021-06-19</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=../../../tags/ctf/>ctf</a>,&nbsp;<a href=../../../tags/flareon/>flareon</a>,&nbsp;<a href=../../../tags/log/>log</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=../../../>Home</a></span></section></div><div class=post-nav><a href=../../../posts/old_posts/2020-09-11-sehveh/ class=prev rel=prev title="Rootme challenge - SEHVEH"><i class="fas fa-angle-left fa-fw"></i>Rootme challenge - SEHVEH</a>
<a href=../../../posts/redpwn2021/ class=next rel=next title="[redpwnCTF2021] pickled-onions, 2k writeups">[redpwnCTF2021] pickled-onions, 2k writeups<i class="fas fa-angle-right fa-fw"></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.98.0">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=../../../ target=_blank>Frost</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw"></i></a></div><script type=text/javascript src=../../../lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=../../../lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=../../../lib/clipboard/clipboard.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:100},comment:{}}</script><script type=text/javascript src=../../../js/theme.min.js></script></body></html>