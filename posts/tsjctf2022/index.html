<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>[TSJ CTF 2022] javascript_vm, w4nn4cryp7 writeup - Frost's blog</title><meta name=Description content><meta property="og:title" content="[TSJ CTF 2022] javascript_vm, w4nn4cryp7 writeup"><meta property="og:description" content="This is another CTF that I get to play with the people at team Project Sekai. The challenges are nice and interesting, and here are my writeups for the 2 RE challenges that I&rsquo;ve managed to solve.
javascript_vm Given file  chall.bin
VM source
   Description  There are two kinds of Javascript virtual machines. Those who understand Javascript (like node.js) and those who don&rsquo;t (like &mldr; ?)."><meta property="og:type" content="article"><meta property="og:url" content="/posts/tsjctf2022/"><meta property="og:image" content="/images/slime-attack.gif"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-02-28T16:43:50+07:00"><meta property="article:modified_time" content="2022-02-28T16:43:50+07:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/images/slime-attack.gif"><meta name=twitter:title content="[TSJ CTF 2022] javascript_vm, w4nn4cryp7 writeup"><meta name=twitter:description content="This is another CTF that I get to play with the people at team Project Sekai. The challenges are nice and interesting, and here are my writeups for the 2 RE challenges that I&rsquo;ve managed to solve.
javascript_vm Given file  chall.bin
VM source
   Description  There are two kinds of Javascript virtual machines. Those who understand Javascript (like node.js) and those who don&rsquo;t (like &mldr; ?)."><meta name=application-name content="LoveIt"><meta name=apple-mobile-web-app-title content="LoveIt"><link rel="shortcut icon" type=image/x-icon href=../../favicon.ico><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=manifest href=../../site.webmanifest><link rel=canonical href=../../posts/tsjctf2022/><link rel=prev href=../../posts/allesctf_2021/><link rel=stylesheet href=../../lib/normalize/normalize.min.css><link rel=stylesheet href=../../css/style.min.css><link rel=stylesheet href=../../lib/fontawesome-free/all.min.css><link rel=stylesheet href=../../lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"[TSJ CTF 2022] javascript_vm, w4nn4cryp7 writeup","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"\/posts\/tsjctf2022\/"},"genre":"posts","keywords":"ctf, writeup","wordcount":3057,"url":"\/posts\/tsjctf2022\/","datePublished":"2022-02-28T16:43:50+07:00","dateModified":"2022-02-28T16:43:50+07:00","publisher":{"@type":"Organization","name":"Frost"},"author":{"@type":"Person","name":"Frost"},"description":""}</script></head><body header-desktop header-mobile><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"dark"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"dark"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=../../ title="Frost's blog"><img class="lazyload logo" src=../../svg/loading.min.svg data-src=../../images/slime-attack.gif data-srcset="../../images/slime-attack.gif, ../../images/slime-attack.gif 1.5x, ../../images/slime-attack.gif 2x" data-sizes=auto alt=/images/slime-attack.gif title=/images/slime-attack.gif></a></div><div class=menu><div class=menu-inner><a class=menu-item href=../../posts/>Posts </a><a class=menu-item href=../../tags/>Tags </a><a class=menu-item href=../../about/>About </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=../../ title="Frost's blog"><img class="lazyload logo" src=../../svg/loading.min.svg data-src=../../images/slime-attack.gif data-srcset="../../images/slime-attack.gif, ../../images/slime-attack.gif 1.5x, ../../images/slime-attack.gif 2x" data-sizes=auto alt=/images/slime-attack.gif title=/images/slime-attack.gif></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=../../posts/ title>Posts</a><a class=menu-item href=../../tags/ title>Tags</a><a class=menu-item href=../../about/ title>About</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">[TSJ CTF 2022] javascript_vm, w4nn4cryp7 writeup</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=../../ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>Frost</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2022-02-28>2022-02-28</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;3057 words&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;15 minutes&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#javascript_vm>javascript_vm</a><ul><li><a href=#writing-a-disassembler>Writing a disassembler</a></li><li><a href=#analysing-the-binary>Analysing the binary</a></li><li><a href=#emulating-the-vm>Emulating the VM:</a></li></ul></li><li><a href=#w4nn4cryp7>w4nn4cryp7:</a><ul><li><a href=#basic-analysis>Basic analysis:</a></li><li><a href=#looking-for-the-encrypt-algorithm>Looking for the encrypt algorithm:</a></li><li><a href=#extracting-key-and-iv>Extracting key and iv:</a></li><li><a href=#decrypting-files>Decrypting files:</a></li></ul></li></ul></nav></div></div><div class=content id=content><p>This is another CTF that I get to play with the people at team <a href=https://sekai.team/ target=_blank rel="noopener noreffer">Project Sekai</a>. The challenges are nice and interesting, and here are my writeups for the 2 RE challenges that I&rsquo;ve managed to solve.</p><h2 id=javascript_vm>javascript_vm</h2><div class="details admonition info open"><div class="details-summary admonition-title"><i class="icon fas fa-info-circle fa-fw"></i>Given file<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content><p><a href=../../posts/tsjctf2022/js_vm/chall.bin rel>chall.bin</a></p><p><a href=https://github.com/francisrstokes/16bitjs target=_blank rel="noopener noreffer">VM source</a></p></div></div></div><div class="details admonition info open"><div class="details-summary admonition-title"><i class="icon fas fa-info-circle fa-fw"></i>Description<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content><p>There are two kinds of Javascript virtual machines. Those who understand Javascript (like node.js) and those who don&rsquo;t (like &mldr; ?).</p><p>Author: @wxrdnx</p></div></div></div><h3 id=writing-a-disassembler>Writing a disassembler</h3><p>This is a classic vm chall. We got a binary file, along with the Github repo for the VM implementation. Having the source code and documentation of the VM is a great help, it means we don&rsquo;t have to spend as much time and effort to understand the instruction set. We just need to look at the right files, write a disassembler and the chall is 50% solved.</p><p>There is a total of <code>14</code> instructions. We can easily find out how they are encoded in binary format by looking at the documentation and the file <a href=https://github.com/francisrstokes/16bitjs/blob/master/src/assembler/assembler/instruction-encoder.js#L30 target=_blank rel="noopener noreffer">src/assembler/assembler/instruction-encoder.js</a>. From there, I was able to write a disassembler for this VM</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>.....</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>decodeIns</span><span class=p>(</span><span class=n>ins</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>op</span> <span class=o>=</span> <span class=n>ins</span> <span class=o>&amp;</span> <span class=mb>0b1111</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>handlers</span><span class=p>[</span><span class=n>op</span><span class=p>](</span><span class=n>ins</span><span class=p>,</span> <span class=n>op</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>handlers</span> <span class=o>=</span> <span class=p>[</span><span class=n>handleMVR</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>handleMVV</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>handleLDR</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>handleSTA</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>handleATH</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>handleCAL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>handleJCP</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>handlePSH</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>handlePOP</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>handleJMP</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>handleJMR</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>handleLDA</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>handleSTR</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>handleNOA</span>
</span></span><span class=line><span class=cl>           <span class=p>]</span>
</span></span><span class=line><span class=cl>      
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;chall.bin&#34;</span><span class=p>,</span> <span class=s2>&#34;rb&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>debug</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>),</span> <span class=mi>2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>i</span><span class=o>//</span><span class=mi>2</span><span class=si>}</span><span class=s2>:&#34;</span><span class=p>,</span> <span class=n>end</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=se>\t</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>decodeIns</span><span class=p>(</span><span class=n>struct</span><span class=o>.</span><span class=n>unpack</span><span class=p>(</span><span class=s2>&#34;&lt;h&#34;</span><span class=p>,</span> <span class=n>data</span><span class=p>[</span><span class=n>i</span><span class=p>:</span><span class=n>i</span><span class=o>+</span><span class=mi>2</span><span class=p>])[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=k>pass</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;WEIRD OPCODE </span><span class=si>{</span><span class=n>struct</span><span class=o>.</span><span class=n>unpack</span><span class=p>(</span><span class=s2>&#34;&lt;h&#34;</span><span class=p>,</span> <span class=n>data</span><span class=p>[</span><span class=n>i</span><span class=p>:</span><span class=n>i</span><span class=o>+</span><span class=mi>2</span><span class=p>])[</span><span class=mi>0</span><span class=p>]</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><div class="details admonition tip open"><div class="details-summary admonition-title"><i class="icon fas fa-lightbulb fa-fw"></i>Tip<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>Instead of reading how each instruction is encoded, you can modify <a href=https://github.com/francisrstokes/16bitjs/blob/master/src/cpu/decoder.js target=_blank rel="noopener noreffer">/src/cpu/decoder.js</a> to make the VM parse and print the instructions instead of executing them. My teammate <code>@eana</code> did that and his result helped me a lot in writing and fixing errors in my disassembler.</div></div></div><h3 id=analysing-the-binary>Analysing the binary</h3><p>After disassembling the opcodes, we can now start analyzing the flow of the program.</p><p>The first 74 instructions seem to be in the same function, we&rsquo;ll call it the <code>main</code> function. There is a call to a function at address 75, this is where the program asks for our input (you can check this out yourself).</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=err>0:</span>	<span class=nf>MVV</span> <span class=no>A</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=err>1:</span>	<span class=nf>JMR</span> <span class=no>A</span>
</span></span><span class=line><span class=cl><span class=err>2:</span>	<span class=nf>MVV</span> <span class=no>D</span><span class=p>,</span> <span class=mi>75</span><span class=p>,</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=err>3:</span>	<span class=nf>MVV</span> <span class=no>D</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=err>4:</span>	<span class=nf>CAL</span> <span class=no>D</span>
</span></span></code></pre></td></tr></table></div></div><p>After that, the program does a bunch of other stuff, but we don&rsquo;t need to care about that for now. The interesting part is at lines <code>27</code> to <code>74</code>. It is a big loop with some comparisons.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=err>27:</span>	<span class=nf>MVV</span> <span class=no>A</span><span class=p>,</span> <span class=mi>29</span><span class=p>,</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=err>28:</span>	<span class=nf>MVV</span> <span class=no>A</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=err>29:</span>	<span class=nf>MVV</span> <span class=no>B</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=err>30:</span>	<span class=nf>MVV</span> <span class=no>B</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=err>31:</span>	<span class=nf>STR</span> <span class=no>A</span><span class=p>,</span> <span class=no>B</span><span class=p>,</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=err>32:</span>	<span class=nf>MVV</span> <span class=no>A</span><span class=p>,</span> <span class=mi>29</span><span class=p>,</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=err>33:</span>	<span class=nf>MVV</span> <span class=no>A</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=err>34:</span>	<span class=nf>LDR</span> <span class=no>C</span><span class=p>,</span> <span class=no>A</span><span class=p>,</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=err>35:</span>	<span class=nf>MVV</span> <span class=no>A</span><span class=p>,</span> <span class=mi>27</span><span class=p>,</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=err>36:</span>	<span class=nf>MVV</span> <span class=no>A</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=err>37:</span>	<span class=nf>LDR</span> <span class=no>A</span><span class=p>,</span> <span class=no>A</span><span class=p>,</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=err>38:</span>	<span class=nf>MVV</span> <span class=no>D</span><span class=p>,</span> <span class=mi>67</span><span class=p>,</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=err>39:</span>	<span class=nf>MVV</span> <span class=no>D</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=err>40:</span>	<span class=nf>JCP</span> <span class=no>C</span><span class=p>,</span> <span class=no>A</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>5</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>41:</span>	<span class=nf>MVV</span> <span class=no>A</span><span class=p>,</span> <span class=mi>191</span><span class=p>,</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=err>42:</span>	<span class=nf>MVV</span> <span class=no>A</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=err>43:</span>	<span class=nf>ATH</span> <span class=no>A</span><span class=p>,</span> <span class=no>C</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=err>44:</span>	<span class=nf>LDR</span> <span class=no>A</span><span class=p>,</span> <span class=no>A</span><span class=p>,</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=err>45:</span>	<span class=nf>MVV</span> <span class=no>B</span><span class=p>,</span> <span class=mi>85</span><span class=p>,</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=err>46:</span>	<span class=nf>MVV</span> <span class=no>B</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=err>47:</span>	<span class=nf>ATH</span> <span class=no>B</span><span class=p>,</span> <span class=no>C</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=err>48:</span>	<span class=nf>LDR</span> <span class=no>B</span><span class=p>,</span> <span class=no>B</span><span class=p>,</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=err>49:</span>	<span class=nf>MVV</span> <span class=no>D</span><span class=p>,</span> <span class=mi>59</span><span class=p>,</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=err>50:</span>	<span class=nf>MVV</span> <span class=no>D</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=err>51:</span>	<span class=nf>JCP</span> <span class=no>A</span><span class=p>,</span> <span class=no>B</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>52:</span>	<span class=nf>MVR</span> <span class=no>C</span><span class=p>,</span> <span class=no>C</span><span class=p>,</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=err>53:</span>	<span class=nf>MVV</span> <span class=no>A</span><span class=p>,</span> <span class=mi>29</span><span class=p>,</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=err>54:</span>	<span class=nf>MVV</span> <span class=no>A</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=err>55:</span>	<span class=nf>STR</span> <span class=no>A</span><span class=p>,</span> <span class=no>C</span><span class=p>,</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=err>56:</span>	<span class=nf>MVV</span> <span class=no>D</span><span class=p>,</span> <span class=mi>32</span><span class=p>,</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=err>57:</span>	<span class=nf>MVV</span> <span class=no>D</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=err>58:</span>	<span class=nf>JMR</span> <span class=no>D</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>59:</span>	<span class=nf>MVV</span> <span class=no>A</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=err>60:</span>	<span class=nf>MVV</span> <span class=no>A</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=err>61:</span>	<span class=nf>MVV</span> <span class=no>B</span><span class=p>,</span> <span class=mi>7</span><span class=p>,</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=err>62:</span>	<span class=nf>MVV</span> <span class=no>B</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=err>63:</span>	<span class=nf>MVV</span> <span class=no>C</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=err>64:</span>	<span class=nf>MVV</span> <span class=no>C</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=err>65:</span>	<span class=nf>NOA</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=err>66:</span>	<span class=nf>NOA</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>67:</span>	<span class=nf>MVV</span> <span class=no>A</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=err>68:</span>	<span class=nf>MVV</span> <span class=no>A</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=err>69:</span>	<span class=nf>MVV</span> <span class=no>B</span><span class=p>,</span> <span class=mi>254</span><span class=p>,</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=err>70:</span>	<span class=nf>MVV</span> <span class=no>B</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=err>71:</span>	<span class=nf>MVV</span> <span class=no>C</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=err>72:</span>	<span class=nf>MVV</span> <span class=no>C</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=err>73:</span>	<span class=nf>NOA</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=err>74:</span>	<span class=nf>NOA</span> <span class=mi>3</span>
</span></span></code></pre></td></tr></table></div></div><p>If you can&rsquo;t see the loop yet, here are the opcodes that my teammate <code>@eana</code> printed out, they are much more intuitive than mine.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=nf>MVV</span> <span class=p>(</span><span class=no>MVI</span><span class=p>)</span> <span class=no>A</span> <span class=err>=</span> <span class=mi>29</span>
</span></span><span class=line><span class=cl><span class=nf>MVV</span> <span class=p>(</span><span class=no>AUI</span><span class=p>)</span> <span class=no>A</span> <span class=err>+=</span> <span class=mi>256</span>
</span></span><span class=line><span class=cl><span class=nf>MVV</span> <span class=p>(</span><span class=no>MVI</span><span class=p>)</span> <span class=no>B</span> <span class=err>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=nf>MVV</span> <span class=p>(</span><span class=no>AUI</span><span class=p>)</span> <span class=no>B</span> <span class=err>+=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=nf>STR</span> <span class=no>Memory</span> <span class=err>@</span> <span class=no>A</span> <span class=err>+</span> <span class=mi>0</span> <span class=err>=</span> <span class=no>B</span>
</span></span><span class=line><span class=cl><span class=nf>MVV</span> <span class=p>(</span><span class=no>MVI</span><span class=p>)</span> <span class=no>A</span> <span class=err>=</span> <span class=mi>29</span>
</span></span><span class=line><span class=cl><span class=nf>MVV</span> <span class=p>(</span><span class=no>AUI</span><span class=p>)</span> <span class=no>A</span> <span class=err>+=</span> <span class=mi>256</span>
</span></span><span class=line><span class=cl><span class=nf>LDR</span> <span class=no>C</span> <span class=err>=</span> <span class=no>Memory</span> <span class=err>@</span> <span class=no>A</span> <span class=err>+</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=nf>MVV</span> <span class=p>(</span><span class=no>MVI</span><span class=p>)</span> <span class=no>A</span> <span class=err>=</span> <span class=mi>27</span>
</span></span><span class=line><span class=cl><span class=nf>MVV</span> <span class=p>(</span><span class=no>AUI</span><span class=p>)</span> <span class=no>A</span> <span class=err>+=</span> <span class=mi>256</span>
</span></span><span class=line><span class=cl><span class=nf>LDR</span> <span class=no>A</span> <span class=err>=</span> <span class=no>Memory</span> <span class=err>@</span> <span class=no>A</span> <span class=err>+</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=nf>MVV</span> <span class=p>(</span><span class=no>MVI</span><span class=p>)</span> <span class=no>D</span> <span class=err>=</span> <span class=mi>67</span>
</span></span><span class=line><span class=cl><span class=nf>MVV</span> <span class=p>(</span><span class=no>AUI</span><span class=p>)</span> <span class=no>D</span> <span class=err>+=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=nf>JCP</span> <span class=no>GTE</span> <span class=no>C</span> <span class=err>&gt;=</span> <span class=no>A</span> <span class=p>--</span><span class=err>&gt;</span> <span class=no>Memory</span> <span class=err>@</span> <span class=no>D</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>MVV</span> <span class=p>(</span><span class=no>MVI</span><span class=p>)</span> <span class=no>A</span> <span class=err>=</span> <span class=mi>191</span>
</span></span><span class=line><span class=cl><span class=nf>MVV</span> <span class=p>(</span><span class=no>AUI</span><span class=p>)</span> <span class=no>A</span> <span class=err>+=</span> <span class=mi>256</span>
</span></span><span class=line><span class=cl><span class=nf>ATH</span> <span class=no>C</span> <span class=no>A</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=nf>Arithmetic</span> <span class=no>A</span> <span class=err>=</span> <span class=no>A</span> <span class=err>+</span> <span class=no>C</span>
</span></span><span class=line><span class=cl><span class=nf>LDR</span> <span class=no>A</span> <span class=err>=</span> <span class=no>Memory</span> <span class=err>@</span> <span class=no>A</span> <span class=err>+</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=nf>MVV</span> <span class=p>(</span><span class=no>MVI</span><span class=p>)</span> <span class=no>B</span> <span class=err>=</span> <span class=mi>85</span>
</span></span><span class=line><span class=cl><span class=nf>MVV</span> <span class=p>(</span><span class=no>AUI</span><span class=p>)</span> <span class=no>B</span> <span class=err>+=</span> <span class=mi>256</span>
</span></span><span class=line><span class=cl><span class=nf>ATH</span> <span class=no>C</span> <span class=no>B</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=nf>Arithmetic</span> <span class=no>B</span> <span class=err>=</span> <span class=no>B</span> <span class=err>+</span> <span class=no>C</span>
</span></span><span class=line><span class=cl><span class=nf>LDR</span> <span class=no>B</span> <span class=err>=</span> <span class=no>Memory</span> <span class=err>@</span> <span class=no>B</span> <span class=err>+</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=nf>MVV</span> <span class=p>(</span><span class=no>MVI</span><span class=p>)</span> <span class=no>D</span> <span class=err>=</span> <span class=mi>59</span>
</span></span><span class=line><span class=cl><span class=nf>MVV</span> <span class=p>(</span><span class=no>AUI</span><span class=p>)</span> <span class=no>D</span> <span class=err>+=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=nf>JCP</span> <span class=no>NEQ</span> <span class=no>A</span> <span class=p>!</span><span class=err>==</span> <span class=no>B</span> <span class=p>--</span><span class=err>&gt;</span> <span class=no>Memory</span> <span class=err>@</span> <span class=no>D</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>MVR</span> <span class=no>C</span> <span class=err>=</span> <span class=no>C</span> <span class=err>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=nf>MVV</span> <span class=p>(</span><span class=no>MVI</span><span class=p>)</span> <span class=no>A</span> <span class=err>=</span> <span class=mi>29</span>
</span></span><span class=line><span class=cl><span class=nf>MVV</span> <span class=p>(</span><span class=no>AUI</span><span class=p>)</span> <span class=no>A</span> <span class=err>+=</span> <span class=mi>256</span>
</span></span><span class=line><span class=cl><span class=nf>STR</span> <span class=no>Memory</span> <span class=err>@</span> <span class=no>A</span> <span class=err>+</span> <span class=mi>0</span> <span class=err>=</span> <span class=no>C</span>
</span></span><span class=line><span class=cl><span class=nf>MVV</span> <span class=p>(</span><span class=no>MVI</span><span class=p>)</span> <span class=no>D</span> <span class=err>=</span> <span class=mi>32</span>
</span></span><span class=line><span class=cl><span class=nf>MVV</span> <span class=p>(</span><span class=no>AUI</span><span class=p>)</span> <span class=no>D</span> <span class=err>+=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=nf>JMR</span> <span class=no>D</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>MVV</span> <span class=p>(</span><span class=no>MVI</span><span class=p>)</span> <span class=no>A</span> <span class=err>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=nf>MVV</span> <span class=p>(</span><span class=no>AUI</span><span class=p>)</span> <span class=no>A</span> <span class=err>+=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=nf>MVV</span> <span class=p>(</span><span class=no>MVI</span><span class=p>)</span> <span class=no>B</span> <span class=err>=</span> <span class=mi>7</span>
</span></span><span class=line><span class=cl><span class=nf>MVV</span> <span class=p>(</span><span class=no>AUI</span><span class=p>)</span> <span class=no>B</span> <span class=err>+=</span> <span class=mi>512</span>
</span></span><span class=line><span class=cl><span class=nf>MVV</span> <span class=p>(</span><span class=no>MVI</span><span class=p>)</span> <span class=no>C</span> <span class=err>=</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl><span class=nf>MVV</span> <span class=p>(</span><span class=no>AUI</span><span class=p>)</span> <span class=no>C</span> <span class=err>+=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=nf>NOA</span> <span class=no>SYS</span>
</span></span><span class=line><span class=cl><span class=nf>NOA</span> <span class=no>HLT</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>MVV</span> <span class=p>(</span><span class=no>MVI</span><span class=p>)</span> <span class=no>A</span> <span class=err>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=nf>MVV</span> <span class=p>(</span><span class=no>AUI</span><span class=p>)</span> <span class=no>A</span> <span class=err>+=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=nf>MVV</span> <span class=p>(</span><span class=no>MVI</span><span class=p>)</span> <span class=no>B</span> <span class=err>=</span> <span class=mi>254</span>
</span></span><span class=line><span class=cl><span class=nf>MVV</span> <span class=p>(</span><span class=no>AUI</span><span class=p>)</span> <span class=no>B</span> <span class=err>+=</span> <span class=mi>256</span>
</span></span><span class=line><span class=cl><span class=nf>MVV</span> <span class=p>(</span><span class=no>MVI</span><span class=p>)</span> <span class=no>C</span> <span class=err>=</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl><span class=nf>MVV</span> <span class=p>(</span><span class=no>AUI</span><span class=p>)</span> <span class=no>C</span> <span class=err>+=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=nf>NOA</span> <span class=no>SYS</span>
</span></span><span class=line><span class=cl><span class=nf>NOA</span> <span class=no>HLT</span>
</span></span></code></pre></td></tr></table></div></div><p>At addresses <code>44</code> and <code>48</code>, we can see 2 values got loaded from the memory. After that, those values are compared with each other and if they are not equal, we jump to address <code>59</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=err>44:</span>	<span class=nf>LDR</span> <span class=no>A</span><span class=p>,</span> <span class=no>A</span><span class=p>,</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=err>45:</span>	<span class=nf>MVV</span> <span class=no>B</span><span class=p>,</span> <span class=mi>85</span><span class=p>,</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=err>46:</span>	<span class=nf>MVV</span> <span class=no>B</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=err>47:</span>	<span class=nf>ATH</span> <span class=no>B</span><span class=p>,</span> <span class=no>C</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=err>48:</span>	<span class=nf>LDR</span> <span class=no>B</span><span class=p>,</span> <span class=no>B</span><span class=p>,</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=err>49:</span>	<span class=nf>MVV</span> <span class=no>D</span><span class=p>,</span> <span class=mi>59</span><span class=p>,</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=err>50:</span>	<span class=nf>MVV</span> <span class=no>D</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=err>51:</span>	<span class=nf>JCP</span> <span class=no>A</span><span class=p>,</span> <span class=no>B</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>1</span>
</span></span></code></pre></td></tr></table></div></div><p>The instructions at address <code>59</code> tell the VM to print a string from memory, the address of the string is stored inside register <code>B</code> (check the documentation of <code>NOA 2</code> instruction for more info).</p><p>We can calculate the address ourselves and search for the needed string inside the binary, and it turns out that the program is trying to print <code>Wrong</code> at address <code>519</code>.
Similarly, we can see that the instructions at address <code>67</code> to <code>74</code> print out <code>Correct</code>.</p><p>So now the flow of the program is quite clear. It first gets our input, does something with it, then finally validates it char by char using the comparisons at address <code>51</code>.</p><h3 id=emulating-the-vm>Emulating the VM:</h3><p>To find the correct input, we only need to make sure that at address <code>51</code>, the program doesn&rsquo;t jump to the <code>Wrong</code> branch. So my solution is as follow:</p><ul><li>Emulating the whole VM in Python</li><li>When the program asks for input from stdin, we inject a z3 BitVec to memory.</li><li>When the program reaches address <code>51</code>, we skip the comparisons, add a constraint to our z3 solver, then move to the correct branch</li></ul><p>With this approach, we don&rsquo;t need to care about how the program encodes our input. I think it&rsquo;s a very good way to deal with VM-type challenges in general.</p><p>Since my disassembler is already written in Python, what I need to do now is just modifying the disassembler so that it runs the code instead of just parsing them.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>handleMVR</span><span class=p>(</span><span class=n>ins</span><span class=p>,</span> <span class=n>op</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>ip</span>
</span></span><span class=line><span class=cl>    <span class=c1>#parse</span>
</span></span><span class=line><span class=cl>    <span class=n>dst</span> <span class=o>=</span> <span class=p>(</span><span class=n>ins</span> <span class=o>&gt;&gt;</span> <span class=mi>4</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mb>0b11</span>
</span></span><span class=line><span class=cl>    <span class=n>src</span> <span class=o>=</span> <span class=p>(</span><span class=n>ins</span> <span class=o>&gt;&gt;</span> <span class=mi>6</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mb>0b11</span>
</span></span><span class=line><span class=cl>    <span class=n>val</span> <span class=o>=</span> <span class=n>ins</span> <span class=o>&gt;&gt;</span> <span class=mi>8</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>#exec</span>
</span></span><span class=line><span class=cl>    <span class=n>regs</span><span class=p>[</span><span class=n>regMap</span><span class=p>[</span><span class=n>dst</span><span class=p>]]</span> <span class=o>=</span> <span class=n>regs</span><span class=p>[</span><span class=n>regMap</span><span class=p>[</span><span class=n>src</span><span class=p>]]</span> <span class=o>+</span> <span class=n>val</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>debug</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>insMap</span><span class=p>[</span><span class=n>op</span><span class=p>]</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=n>regMap</span><span class=p>[</span><span class=n>dst</span><span class=p>]</span><span class=si>}</span><span class=s2>, </span><span class=si>{</span><span class=n>regMap</span><span class=p>[</span><span class=n>src</span><span class=p>]</span><span class=si>}</span><span class=s2>, </span><span class=si>{</span><span class=n>val</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>Then change the <code>syscall()</code> function to inject our z3 symbols.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>symbols</span> <span class=o>=</span> <span class=p>[</span><span class=n>BitVec</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;x</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=mi>8</span><span class=p>)</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>52</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=n>s</span> <span class=o>=</span> <span class=n>Solver</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>symCounter</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=o>....</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>syscall</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>symCounter</span>
</span></span><span class=line><span class=cl><span class=o>....</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>regs</span><span class=p>[</span><span class=s2>&#34;A&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>regs</span><span class=p>[</span><span class=s2>&#34;B&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>symbols</span><span class=p>[</span><span class=n>symCounter</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>symCounter</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;INPUT&#34;</span><span class=p>,</span> <span class=n>end</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=se>\t</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>ValueError</span>
</span></span></code></pre></td></tr></table></div></div><p>And finally, we patch the jump at address <code>51</code> and add our constraints</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>handleJCP</span><span class=p>(</span><span class=n>ins</span><span class=p>,</span> <span class=n>op</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=o>....</span>
</span></span><span class=line><span class=cl>    <span class=n>jumpAddr</span> <span class=o>=</span> <span class=n>regs</span><span class=p>[</span><span class=n>regMap</span><span class=p>[</span><span class=n>addr</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>	<span class=o>....</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>operation</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>ip</span> <span class=o>==</span> <span class=mi>51</span><span class=p>:</span>    <span class=c1>#Special address</span>
</span></span><span class=line><span class=cl>            <span class=n>s</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>regs</span><span class=p>[</span><span class=n>regMap</span><span class=p>[</span><span class=n>dst</span><span class=p>]]</span> <span class=o>==</span> <span class=n>regs</span><span class=p>[</span><span class=n>regMap</span><span class=p>[</span><span class=n>src</span><span class=p>]])</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>regs</span><span class=p>[</span><span class=n>regMap</span><span class=p>[</span><span class=n>dst</span><span class=p>]]</span> <span class=o>!=</span> <span class=n>regs</span><span class=p>[</span><span class=n>regMap</span><span class=p>[</span><span class=n>src</span><span class=p>]]:</span>
</span></span><span class=line><span class=cl>			<span class=n>ip</span> <span class=o>=</span> <span class=n>jumpAddr</span> <span class=o>-</span> <span class=mi>1</span>
</span></span></code></pre></td></tr></table></div></div><p>After the program finishes executing, we can eval our equations and get the flag: <code>TSJ{17_15_n07_7h3_j4v45cr1p7_vm_y0u_r_f4m1l14r_w17h}</code></p><div class="details admonition info"><div class="details-summary admonition-title"><i class="icon fas fa-info-circle fa-fw"></i>Solve scripts<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content><p>Disassembler: <a href=../../posts/tsjctf2022/js_vm/disass.py rel>disass.py</a></p><p>Emulator: <a href=../../posts/tsjctf2022/js_vm/emu.py rel>emu.py</a></p></div></div></div><h2 id=w4nn4cryp7>w4nn4cryp7:</h2><p>Team Sekai stops doing this CTF halfway to focus on another CTF. So I have to solve this all alone :sadge:</p><div class="details admonition info open"><div class="details-summary admonition-title"><i class="icon fas fa-info-circle fa-fw"></i>Given file<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content><p>Original file, binary and dump file inside: <a href="https://chal.ctf.tsj.tw/files/6e6d0b313dd482e9819657d51438ef01/w4nn4cryp7.zip?token=eyJ1c2VyX2lkIjo3MjUsInRlYW1faWQiOjM5MiwiZmlsZV9pZCI6MjZ9.Yhz7FA.vVBvin0ycmlreXzWuZx6nkEZe-w" target=_blank rel="noopener noreffer">w4nn4cryp7.zip</a></p><p>For those who don&rsquo;t want to download the entire thing:</p><ul><li>Binary: <a href=../../posts/tsjctf2022/w4nn4cryp7/encoder.exe rel>encoder.exe</a></li><li>Dump file: <a href=../../posts/tsjctf2022/w4nn4cryp7/encoder.DMP rel>encoder.DMP</a></li><li>Encrypted flag: <a href=w4nn4cryp7/CH4_Metasploit.txt.LMFAO rel>CH4_Metasploit.txt.LMFAO</a></li></ul></div></div></div><div class="details admonition info open"><div class="details-summary admonition-title"><i class="icon fas fa-info-circle fa-fw"></i>Description<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content><p>Oh nyo! TSJ&rsquo;s PC has been infected by the w4nn4cryp7 malware! Hopefully, TSJ created a dump file for malware analysts to investigate. Can you help TSJ recover his infected C drive?</p><p>NOTE 1: encoder.exe IS A REAL MALWARE! PLEASE SOLVE THIS CHALLENGE IN A VIRTUAL MACHINE ENVIRONMENT!!!</p><p>Note 2: The flag is ASCII art, and it is hidden in one of the files in TSJ&rsquo;s C drive.</p><p>Author: @wxrdnx</p></div></div></div><h3 id=basic-analysis>Basic analysis:</h3><p>We are given a PE file, along with a <code>.DMP</code> file and an infected drive with many encrypted files.</p><p>The PE file is packed with UPX, so we need to unpack it before loading it to a disassembler. All the symbols are stripped, so it&rsquo;s going to be a little bit harder to analyze this binary. A good place to start is the <code>main</code> function, there are many ways online that show you how to locate the main function in a PE binary. For this particular file, <code>main</code> is at <code>0x401571</code></p><p>Since this is a stripped binary, we don&rsquo;t know which one is a library function and may waste a lot of time trying to reverse unnecessary code. My way to deal with such binary is just trying to guess what each function does using strings, debugging, etc., and staying away from all the codes that I think are too complex.</p><p>Based on the strings in the binary, we can see that the program first check if we supplied a directory name, then it goes on to check if the name is <code>victim</code>. If these checks fail, the program exits.</p><p>After that, we come to a small loop.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>while</span> <span class=p>(</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kr>__int8</span><span class=p>)</span><span class=n>sub_55E680</span><span class=p>(</span><span class=n>v81</span><span class=p>,</span> <span class=n>v80</span><span class=p>)</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>	  <span class=n>v6</span> <span class=o>=</span> <span class=n>sub_4F9E70</span><span class=p>(</span><span class=n>v81</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	  <span class=n>v7</span> <span class=o>=</span> <span class=n>sub_4F9CE0</span><span class=p>(</span><span class=n>v6</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	  <span class=n>sub_55CD60</span><span class=p>(</span><span class=n>v71</span><span class=p>,</span> <span class=n>v7</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	  <span class=n>sub_4FC6E0</span><span class=p>(</span><span class=n>v72</span><span class=p>,</span> <span class=n>v71</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	  <span class=k>if</span> <span class=p>(</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kr>__int8</span><span class=p>)</span><span class=n>sub_55E6B0</span><span class=p>(</span><span class=n>v72</span><span class=p>,</span> <span class=n>v78</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kr>__int8</span><span class=p>)</span><span class=n>sub_552D90</span><span class=p>(</span><span class=n>v71</span><span class=p>)</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>sub_591540</span><span class=p>(</span><span class=n>v79</span><span class=p>,</span> <span class=n>v71</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	  <span class=n>sub_55CFE0</span><span class=p>(</span><span class=n>v72</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	  <span class=n>sub_55CFE0</span><span class=p>(</span><span class=n>v71</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	  <span class=n>sub_559340</span><span class=p>((</span><span class=kt>int</span><span class=p>)</span><span class=n>v81</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Thanks to the error message inside <code>sub_559340</code>, we know that the program is looping through every file inside the <code>victim</code> directory.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl> <span class=k>if</span> <span class=p>(</span> <span class=n>v8</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>v6</span> <span class=o>=</span> <span class=n>sub_5CED50</span><span class=p>(</span><span class=mi>48</span><span class=n>i64</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>sub_5D0FE0</span><span class=p>(</span><span class=n>v9</span><span class=p>,</span> <span class=s>&#34;cannot increment recursive directory iterator&#34;</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>After some reading and debugging, I found out that the program will add all the filenames (except for <code>encoder.exe</code>) inside the <code>victim</code> directory to some kind of list. It will probably open every file in this list and encrypt them later.</p><p>After that, we see a call to <code>sub_4A59F0</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kr>__int64</span> <span class=kr>__fastcall</span> <span class=nf>sub_4A59F0</span><span class=p>(</span><span class=n>_QWORD</span> <span class=o>*</span><span class=n>a1</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kr>__int8</span> <span class=n>a2</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>a3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>sub_466300</span><span class=p>(</span><span class=n>a1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=o>*</span><span class=n>a1</span> <span class=o>=</span> <span class=n>off_611010</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>sub_460690</span><span class=p>(</span><span class=n>a1</span><span class=p>,</span> <span class=n>a2</span><span class=p>,</span> <span class=n>a3</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>This is a pretty interesting function. Since a C++ object always starts with a pointer to the <a href=https://en.wikipedia.org/wiki/Virtual_method_table target=_blank rel="noopener noreffer">vtable</a>, and the <code>vtable</code> is usually stored in the binary as a global array, the statement <code>*a1 = off_611010;</code> makes me suspect that this may be a constructor of some class. Jumping to that address in IDA confirms my suspicion.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>.rdata:0000000000611000 ; `vtable for&#39;CryptoPP::AutoSeededRandomPool
</span></span><span class=line><span class=cl>.rdata:0000000000611000 _ZTVN8CryptoPP20AutoSeededRandomPoolE dq 0 ; offset to this
</span></span><span class=line><span class=cl>.rdata:0000000000611008                 dq offset _ZTIN8CryptoPP20AutoSeededRandomPoolE ; `typeinfo for&#39;CryptoPP::AutoSeededRandomPool
</span></span><span class=line><span class=cl>.rdata:0000000000611010 off_611010      dq offset sub_4A5A90    ; DATA XREF: sub_4A59F0+27?o
</span></span><span class=line><span class=cl>.rdata:0000000000611010                                         ; sub_4A5A90+C?o
</span></span><span class=line><span class=cl>.rdata:0000000000611018                 dq offset sub_4A5A60
</span></span><span class=line><span class=cl>.rdata:0000000000611020                 dq offset sub_4F6CE0
</span></span><span class=line><span class=cl>.rdata:0000000000611028                 dq offset sub_4F7030
</span></span><span class=line><span class=cl>.rdata:0000000000611030                 dq offset sub_4F70A0
</span></span><span class=line><span class=cl>.....................
</span></span></code></pre></td></tr></table></div></div><p>IDA recognize the data structure at 0x611010 as the vtable for class <code>CryptoPP::AutoSeededRandomPool</code>, which means that <code>sub_4A59F0</code> is indeed the constructor for <code>CryptoPP::AutoSeededRandomPool</code>.</p><p>So after some basic analysis, we now know that:</p><ul><li>The malware puts all filenames inside directory <code>victim</code> inside a list, possibly to encrypt them later on.</li><li>The malware uses CryptoPP library for some purpose, maybe to encrypt the files.</li></ul><h3 id=looking-for-the-encrypt-algorithm>Looking for the encrypt algorithm:</h3><p>To decrypt all the given files, we have to find out what encrypt algorithm is used. Using some plugin like <a href=https://github.com/polymorf/findcrypt-yara target=_blank rel="noopener noreffer">findcrypt-yara</a>, we know that the malware either uses AES or RC6. But we don&rsquo;t know the block size and which mode of operation it uses, so we have to turn back to the code.</p><p>Using the same technique as above, we see that <code>sub_4A59F0</code> is actually a constructor for class <code>CryptoPP::AutoSeededRandomPool</code>, which is used to generate random bytes. And at <code>0x40192F</code>, the <code>AutoSeededRandomPool</code> object is used as a param to another function.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl>        <span class=n>sub_4031F0</span><span class=p>(</span><span class=n>randomPool</span><span class=p>,</span> <span class=n>randomByte1</span><span class=p>,</span> <span class=n>v9</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>sub_4031F0</span><span class=p>(</span><span class=n>randomPool</span><span class=p>,</span> <span class=n>randomByte2</span><span class=p>,</span> <span class=mi>16</span><span class=n>i64</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>The parameters it passes to <code>sub_4031F0</code> include an object of type <code>AutoSeededRandomPool</code>, a pointer to a buffer (check the asm code!), and a number. It&rsquo;s fair to guess that this is a function to generate some random bytes to a specified buffer, and those random bytes may also be our key and iv.</p><p>Next, we come to a big loop. The program actually iterates through the list of names we mentioned above. Inside this loop, there is a call to <code>sub_4BD0E0</code>, we can easily identify this function as the constructor for class <code>CryptoPP::CipherModeFinalTemplate_CipherHolder&lt;CryptoPP::BlockCipherFinal&lt;(CryptoPP::CipherDir)0,CryptoPP::RC6::Enc>,CryptoPP::CBC_Encryption></code></p><p>The name is really long, but we can see the 2 class names <code>CryptoPP::RC6::Enc</code> and <code>CryptoPP::CBC_Encryption</code> inside the above template class. There seem to be no other crypto functions in the program, so I concluded that the malware uses <code>RC6</code> with <code>CBC mode</code> to encrypt our files.</p><p>Finally, we need the key and iv. Checking the <a href=https://www.cryptopp.com/wiki/RC6 target=_blank rel="noopener noreffer">sample code</a> from CryptoPP for <code>RC6</code>, we see that the function <code>SetKeyWithIV</code> is used to specify the key and iv for the encryption. There is a function with the same signature in the malware.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>sub_4AC050</span><span class=p>(</span><span class=o>&amp;</span><span class=n>cipherObject</span><span class=p>,</span> <span class=n>randomByte1</span><span class=p>,</span> <span class=n>randomByte1_len</span><span class=p>,</span> <span class=n>randomByte2</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>The random bytes generated using <code>AutoSeededRandomPool</code> is now used as key and iv for <code>RC6</code>, this seems plausible! Now we just need to extract those values from the dump files and it&rsquo;s done.</p><h3 id=extracting-key-and-iv>Extracting key and iv:</h3><p>I had never actually analyzed a dump file before, so this step took me a lot of time. In my opinion, the best tool for this is <code>Windbg</code>.</p><p>Firstly, key and iv are stored on stack, so we can use command <code>k</code> to view stack frames. The result are as followed</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl> # Child-SP          RetAddr               Call Site
</span></span><span class=line><span class=cl>00 00000000`0086ee78 00007fff`833364cc     win32u!NtUserWaitMessage+0x14
</span></span><span class=line><span class=cl>01 00000000`0086ee80 00007fff`8335924b     user32!DialogBox2+0x254
</span></span><span class=line><span class=cl>02 00000000`0086ef20 00007fff`8337d346     user32!InternalDialogBox+0x14b
</span></span><span class=line><span class=cl>03 00000000`0086ef80 00007fff`8337bc91     user32!SoftModalMessageBox+0x836
</span></span><span class=line><span class=cl>04 00000000`0086f0c0 00007fff`8337ca78     user32!MessageBoxWorker+0x341
</span></span><span class=line><span class=cl>05 00000000`0086f270 00007fff`8337c878     user32!MessageBoxTimeoutW+0x198
</span></span><span class=line><span class=cl>06 00000000`0086f370 00007fff`8337c48e     user32!MessageBoxTimeoutA+0x108
</span></span><span class=line><span class=cl>07 00000000`0086f3d0 00000000`00401c0f     user32!MessageBoxA+0x4e
</span></span><span class=line><span class=cl>08 00000000`0086f410 00000000`004013c1     encoder+0x1c0f
</span></span><span class=line><span class=cl>09 00000000`0086fe30 00000000`004014f6     encoder+0x13c1
</span></span><span class=line><span class=cl>0a 00000000`0086ff00 00007fff`83c954e0     encoder+0x14f6
</span></span><span class=line><span class=cl>0b 00000000`0086ff30 00007fff`8502485b     kernel32!BaseThreadInitThunk+0x10
</span></span><span class=line><span class=cl>0c 00000000`0086ff60 00000000`00000000     ntdll!RtlUserThreadStart+0x2b
</span></span></code></pre></td></tr></table></div></div><p>Based on the RetAddr field, we can see that the stack frame for the <code>main</code> function is frame <code>8</code>.
Next, I use <code>.frame /r 8</code> to see the frame context, this gives me the value of <code>rbp</code> of this frame</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>08 00000000`0086f410 00000000`004013c1     encoder+0x1c0f
</span></span><span class=line><span class=cl>rax=000000000000100a rbx=0000000002cc3530 rcx=0000000000007fff
</span></span><span class=line><span class=cl>rdx=00000000010d7dc0 rsi=000000000296d340 rdi=00000000010c13c0
</span></span><span class=line><span class=cl>rip=0000000000401c0f rsp=000000000086f410 rbp=000000000086f490
</span></span><span class=line><span class=cl> r8=000000000086eca0  r9=000000000086eeb8 r10=00000000014aaac0
</span></span><span class=line><span class=cl>r11=000000000086eb80 r12=0000000000000018 r13=00000000010c1360
</span></span><span class=line><span class=cl>r14=0000000000000000 r15=0000000000000000
</span></span><span class=line><span class=cl>iopl=0         nv up ei pl zr na po nc
</span></span><span class=line><span class=cl>cs=0033  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246
</span></span></code></pre></td></tr></table></div></div><p>Combine this with the stack info from IDA, we now know the absolute address of <code>key</code> and <code>iv</code> in memory, so we just need to use <code>db</code> to dump them out.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>key: 7b b7 9d 90 14 59 67 1c af 46 4f 25 4b 22 95 10
</span></span><span class=line><span class=cl>iv: 78 51 18 b9 d7 a5 74 a0 ad 8f 7a 1c 7f 8c b7 e2
</span></span></code></pre></td></tr></table></div></div><h3 id=decrypting-files>Decrypting files:</h3><p>All we need to do now is write a script to decrypt our files.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span><span class=o>**</span> <span class=n>argv</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>argc</span> <span class=o>!=</span> <span class=mi>2</span><span class=p>){</span><span class=k>return</span> <span class=mi>1</span><span class=p>;}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>byte</span> <span class=n>keyData</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span><span class=mi>123</span><span class=p>,</span> <span class=mi>183</span><span class=p>,</span> <span class=mi>157</span><span class=p>,</span> <span class=mi>144</span><span class=p>,</span> <span class=mi>20</span><span class=p>,</span> <span class=mi>89</span><span class=p>,</span> <span class=mi>103</span><span class=p>,</span> <span class=mi>28</span><span class=p>,</span> <span class=mi>175</span><span class=p>,</span> <span class=mi>70</span><span class=p>,</span> <span class=mi>79</span><span class=p>,</span> <span class=mi>37</span><span class=p>,</span> <span class=mi>75</span><span class=p>,</span> <span class=mi>34</span><span class=p>,</span> <span class=mi>149</span><span class=p>,</span> <span class=mi>16</span><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=n>SecByteBlock</span> <span class=n>key</span><span class=p>(</span><span class=n>keyData</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>keyData</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>byte</span> <span class=n>iv</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span><span class=mi>120</span><span class=p>,</span> <span class=mi>81</span><span class=p>,</span> <span class=mi>24</span><span class=p>,</span> <span class=mi>185</span><span class=p>,</span> <span class=mi>215</span><span class=p>,</span> <span class=mi>165</span><span class=p>,</span> <span class=mi>116</span><span class=p>,</span> <span class=mi>160</span><span class=p>,</span> <span class=mi>173</span><span class=p>,</span> <span class=mi>143</span><span class=p>,</span> <span class=mi>122</span><span class=p>,</span> <span class=mi>28</span><span class=p>,</span> <span class=mi>127</span><span class=p>,</span> <span class=mi>140</span><span class=p>,</span> <span class=mi>183</span><span class=p>,</span> <span class=mi>226</span><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>string</span> <span class=n>plain</span> <span class=o>=</span> <span class=s>&#34;CBC Mode Test&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>//string cipher, encoded, recovered;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>string</span> <span class=n>encoded</span><span class=p>,</span> <span class=n>recovered</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>std</span><span class=o>::</span><span class=n>ifstream</span> <span class=n>fin</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>ios</span><span class=o>::</span><span class=n>binary</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>ostringstream</span> <span class=n>ostrm</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>ostrm</span> <span class=o>&lt;&lt;</span> <span class=n>fin</span><span class=p>.</span><span class=n>rdbuf</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=n>string</span> <span class=n>cipher</span><span class=p>(</span> <span class=n>ostrm</span><span class=p>.</span><span class=n>str</span><span class=p>()</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>try</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>CBC_Mode</span><span class=o>&lt;</span> <span class=n>RC6</span> <span class=o>&gt;::</span><span class=n>Decryption</span> <span class=n>d</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>d</span><span class=p>.</span><span class=n>SetKeyWithIV</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>key</span><span class=p>.</span><span class=n>size</span><span class=p>(),</span> <span class=n>iv</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// The StreamTransformationFilter removes
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//  padding as required.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>StringSource</span> <span class=n>s</span><span class=p>(</span><span class=n>cipher</span><span class=p>,</span> <span class=nb>true</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>StreamTransformationFilter</span><span class=p>(</span><span class=n>d</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=k>new</span> <span class=n>StringSink</span><span class=p>(</span><span class=n>recovered</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span> <span class=c1>// StreamTransformationFilter
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>);</span> <span class=c1>// StringSource
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=n>recovered</span> <span class=o>&lt;&lt;</span> <span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>catch</span><span class=p>(</span><span class=k>const</span> <span class=n>CryptoPP</span><span class=o>::</span><span class=n>Exception</span><span class=o>&amp;</span> <span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>cerr</span> <span class=o>&lt;&lt;</span> <span class=n>e</span><span class=p>.</span><span class=n>what</span><span class=p>()</span> <span class=o>&lt;&lt;</span> <span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>It took quite a long time for me to find the correct file with the flag, but finally, I got it:
<code>TSJ{Purchasing_iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea_DOT_com_wont_stop_me_from_going_brrrrr_LMAO}</code></p><p>(The correct file is <code>CH4 Metasploit.txt.LMFAO</code>)</p><div class="details admonition info"><div class="details-summary admonition-title"><i class="icon fas fa-info-circle fa-fw"></i>Solve scripts<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content><p>Decrypting script: <a href=../../posts/tsjctf2022/w4nn4cryp7/decrypt.cpp rel>decrypt.cpp</a></p><p>Idb file: <a href=../../posts/tsjctf2022/w4nn4cryp7/encoder.bin.i64 rel>encoder.bin.i64</a></p></div></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2022-02-28</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=../../tags/ctf/>ctf</a>,&nbsp;<a href=../../tags/writeup/>writeup</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=../../>Home</a></span></section></div><div class=post-nav><a href=../../posts/allesctf_2021/ class=prev rel=prev title="[AllesCTF2021] Monstrosity writeup"><i class="fas fa-angle-left fa-fw"></i>[AllesCTF2021] Monstrosity writeup</a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.99.0">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=../../ target=_blank>Frost</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw"></i></a></div><script type=text/javascript src=../../lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=../../lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=../../lib/clipboard/clipboard.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:100},comment:{}}</script><script type=text/javascript src=../../js/theme.min.js></script></body></html>